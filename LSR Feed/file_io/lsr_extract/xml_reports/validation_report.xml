<?xml version="1.0" encoding="UTF-8"?>

<!--    INVOICE VALIDATION REPORT.  THIS REPORT COMPARES THE TOTAL THAT IBM WILL INVOICE LENOVO  -->
<!--    WITH THE TOTAL THAT LENOVO IS EXPECTING IBM TO INVOICE  -->

<!-- Modification History                            	 		-->
<!-- 07/17/2008 | VM | First Cut					-->
<!-- 2009-05-01 | VM | Added in the one time Parts Management Fee Credit - to remove see '003' -->
<!-- 2009-08-17 | VM | Changed the target period to use the new LEN_DATA_REC flag -->
<!-- 2009-12-08 | VM | Added 001 code for transaction reversals -->
<!-- 2010-09-20 | VM | Added 004 credit code for new ACE discount rate -->


<!DOCTYPE reports SYSTEM "./../../dtd/LSRExtract.dtd">

<reports>
 
  <multiReport>
      <fileName text="validation_report.csv" />
      <dateFormat text="MMMM dd yyyy" />
      <timeFormat text="HH:MM:SS" />

      <subReport includeHeader="Db2Header" includeTotals="N">
      	<SQL text="
      	
		WITH TARGET_PERIOD(PERIOD_END_DTE) AS (
		SELECT MAX(PERIOD_END_DTE) FROM LENOVO.PERIOD_DATES WHERE LEN_DATA_REC = 'Y'
		),

		PARTS_CREDIT(KEY, PARTS_CREDIT) AS 
		( 
		SELECT 'PARTS', 
		VALUE(SUM(PART_CREDIT),0) AS PARTS_CREDIT 
		FROM LENOVO.PL_ALL_BYWW_V 
		WHERE EFFECTIVE_PERIOD IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 
		AND DETAIL_STATUS = 'APPROVED' 
		AND WW_CDE = '61' 
		AND COUNTRY_CDE = '649'
		),

		PARTS_WAC(KEY, PARTS_WAC) AS 
		(
		SELECT 'PARTS', 
		VALUE(SUM(PART_COST), 0) AS PART_WAC
		FROM LENOVO.PL_ALL_BYWW_V 
		WHERE EFFECTIVE_PERIOD IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 
		AND DETAIL_STATUS = 'APPROVED' 
		AND WW_CDE = '60'
		AND COUNTRY_CDE = '649'
		),

		PARTS_OTHER(KEY, PARTS_OTHER) AS 
		(
		SELECT 'PARTS', 
		VALUE(SUM(PART_COST), 0) AS PARTS_OTHER
		FROM LENOVO.PL_ALL_BYWW_V 
		WHERE EFFECTIVE_PERIOD IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 
		AND DETAIL_STATUS = 'APPROVED' 
		AND WW_CDE NOT IN('61', '60')
		AND COUNTRY_CDE = '649'
		),

		PARTS_DIST(KEY, PARTS_DIST) AS 
		(
		SELECT 'PARTS', 
		VALUE(SUM(BILLING_RATE * TRANSACTION_CNT), 0) AS PARTS_DIST
		FROM LENOVO.PL_ALL_BYWW_V 
		WHERE EFFECTIVE_PERIOD IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 
		AND DETAIL_STATUS = 'APPROVED' 
		AND WW_CDE NOT IN('61', '60')
		AND COUNTRY_CDE = '649'
		),

		PARTS_FEE(KEY, PARTS_FEE) AS 
		(
		SELECT 'PARTS', 
		VALUE(ROUND(PART_MANAGE_FEE, 2), 0) AS PARTS_FEE
		FROM LENOVO.APPR_FEE15 WHERE PERIOD_END_DTE IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 
		AND COUNTRY_CDE = '649'
		),

		PARTS AS
		(
		SELECT VALUE(PARTS_WAC, 0) +  VALUE(PARTS_OTHER, 0)  +  VALUE(PARTS_DIST, 0) + VALUE(PARTS_FEE, 0) - VALUE(PARTS_CREDIT, 0) AS TOTAL_PARTS
		FROM PARTS_WAC A LEFT JOIN PARTS_OTHER B ON A .KEY = B.KEY 
		LEFT JOIN PARTS_CREDIT C ON A.KEY = C.KEY
		LEFT JOIN PARTS_DIST D ON A.KEY = D.KEY
		LEFT JOIN PARTS_FEE E ON A.KEY = E.KEY
		),

		BF AS 
		(
		SELECT SUM(BILLING_RATE * TRANSACTION_CNT) AS TOTAL_BF
		FROM LENOVO.BF_ALL_BYWW_V A
		WHERE EFFECTIVE_PERIOD IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 
		AND DETAIL_STATUS = 'APPROVED'
		AND COUNTRY_CDE = '649'
		),

		RCS AS 
		(
		SELECT SUM(BILLING_RATE * TRANSACTION_CNT) AS TOTAL_RCS
		FROM LENOVO.RCS_ALL_BYWW_V A
		WHERE EFFECTIVE_PERIOD IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 
		AND DETAIL_STATUS = 'APPROVED'
		AND COUNTRY_CDE = '649'
		),

		DR AS 
		(
		SELECT SUM(BILLING_RATE * TRANSACTION_CNT) AS TOTAL_DR
		FROM LENOVO.DR_ALL_BYWW_V A
		WHERE EFFECTIVE_PERIOD IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 
		AND DETAIL_STATUS = 'APPROVED'
		AND COUNTRY_CDE = '649'
		),

		TOTAL_ALL AS 
		(
		SELECT TOTAL_PARTS  AS TOTALS FROM PARTS 
		UNION 
		SELECT TOTAL_RCS   AS TOTALS FROM RCS
		UNION
		SELECT TOTAL_BF   AS TOTALS FROM BF
		UNION
		SELECT TOTAL_DR   AS TOTALS FROM DR
		),
                                
		TOTAL_IBM (KEY, TOTAL_IBM) AS (
		SELECT 'TOTAL', 
		VALUE(ROUND(SUM(TOTALS), 2),0)  FROM TOTAL_ALL
		),

		LENOVO_APPR_SUMRY (KEY, TOTAL_APPR_SUMRY) AS (
		SELECT 
		'TOTAL',    
		VALUE(ROUND(SUM(TOTAL_APPR_AMT), 2),0) FROM LENOVO.APPR_SUMRY WHERE 
		PERIOD_END_DTE  IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 
		AND COUNTRY_CDE = '649'
		),

		LENOVO_APPR_FEE15 (KEY, TOTAL_FEE15) AS (
		SELECT 
		'TOTAL',    
		VALUE(ROUND(PART_MANAGE_FEE, 2),0) FROM LENOVO.APPR_FEE15 WHERE 
		PERIOD_END_DTE  IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 
		AND COUNTRY_CDE = '649'
		),

		TOTAL_LENOVO(KEY, TOTAL_LENOVO) AS (
		SELECT 
		'TOTAL',    
		VALUE(TOTAL_APPR_SUMRY, 0) + VALUE(TOTAL_FEE15, 0)
		FROM LENOVO_APPR_SUMRY A LEFT JOIN LENOVO_APPR_FEE15 B ON A.KEY = B.KEY
		),

                PARTS_CREDIT_CR(KEY, PARTS_CREDIT_CR) AS 
		( 
		SELECT 'PARTS', 
		VALUE(SUM(PART_CREDIT),0) AS PARTS_CREDIT_CR 
		FROM LENOVO.PL_DETAIL_CR 
		WHERE PERIOD_END_DTE IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 
		AND STATUS = 'CREDIT' 
		AND WW_CDE = '61' 
		AND COUNTRY_CDE = '649'
		AND CREDIT_CDE IN ('001', '002', '004')
		),

		PARTS_WAC_CR(KEY, PARTS_WAC_CR) AS 
		(
		SELECT 'PARTS', 
		VALUE(SUM(PART_COST), 0) AS PART_WAC
		FROM LENOVO.PL_DETAIL_CR 
		WHERE PERIOD_END_DTE IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 
		AND STATUS = 'CREDIT' 
		AND WW_CDE = '60'
		AND COUNTRY_CDE = '649'
		AND CREDIT_CDE IN ('001', '002', '004')
		),

		PARTS_OTHER_CR(KEY, PARTS_OTHER_CR) AS 
		(
		SELECT 'PARTS', 
		VALUE(SUM(PART_COST), 0) AS PARTS_OTHER_CR
		FROM LENOVO.PL_DETAIL_CR 
		WHERE PERIOD_END_DTE IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 
		AND STATUS = 'CREDIT' 
		AND WW_CDE NOT IN('61', '60')
		AND COUNTRY_CDE = '649'
		AND CREDIT_CDE IN ('001', '002', '004', '003')
		),

		PARTS_DIST_CR(KEY, PARTS_DIST_CR) AS 
		(
		SELECT 'PARTS', 
		VALUE(SUM(BILLING_RATE * TRANSACTION_CNT), 0) AS PARTS_DIST_CR
		FROM LENOVO.PL_DETAIL_CR 
		WHERE PERIOD_END_DTE IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 
		AND STATUS = 'CREDIT' 
		AND WW_CDE NOT IN('61', '60')
		AND COUNTRY_CDE = '649'
		AND CREDIT_CDE IN ('001', '002', '004')
		),

		PARTS_CR AS
		(
		SELECT VALUE(PARTS_WAC_CR, 0) +  VALUE(PARTS_OTHER_CR, 0)  +  VALUE(PARTS_DIST_CR, 0) - VALUE(PARTS_CREDIT_CR, 0) AS TOTAL_PARTS				
		FROM PARTS_WAC_CR A LEFT JOIN PARTS_OTHER_CR B ON A .KEY = B.KEY 
		LEFT JOIN PARTS_CREDIT_CR C ON A.KEY = C.KEY
		LEFT JOIN PARTS_DIST_CR D ON A.KEY = D.KEY
		),

		BF_CR AS 
		(
		SELECT SUM(BILLING_RATE * TRANSACTION_CNT) AS TOTAL_BF
		FROM LENOVO.BF_DETAIL_CR A
		WHERE PERIOD_END_DTE IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 
		AND STATUS = 'CREDIT'
		AND COUNTRY_CDE = '649'
		AND CREDIT_CDE IN ('001', '002', '004')
		),

		RCS_CR AS 
		(
		SELECT SUM(BILLING_RATE * TRANSACTION_CNT) AS TOTAL_RCS
		FROM LENOVO.RCS_DETAIL_CR A
		WHERE PERIOD_END_DTE IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 
		AND STATUS = 'CREDIT'
		AND COUNTRY_CDE = '649'
		AND CREDIT_CDE IN ('001', '002', '004')
		),

		DR_CR AS 
		(
		SELECT SUM(BILLING_RATE * TRANSACTION_CNT) AS TOTAL_DR
		FROM LENOVO.DR_DETAIL_CR A
		WHERE PERIOD_END_DTE IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 
		AND STATUS = 'CREDIT'
		AND COUNTRY_CDE = '649'
		AND CREDIT_CDE IN ('001', '002', '004')
		),

		TOTAL_ALL_CR AS 
		(
		SELECT TOTAL_PARTS  AS TOTALS FROM PARTS_CR
		UNION 
		SELECT TOTAL_RCS   AS TOTALS FROM RCS_CR
		UNION
		SELECT TOTAL_BF   AS TOTALS FROM BF_CR
		UNION
		SELECT TOTAL_DR   AS TOTALS FROM DR_CR
		),

		TOTAL_IBM_CREDITS (KEY, TOTAL_IBM_CREDITS) AS (
		SELECT 'TOTAL', 
                VALUE(ROUND(SUM(TOTALS), 2),0) FROM TOTAL_ALL_CR
		)

		SELECT 
		CASE WHEN ABS(TOTAL_IBM - TOTAL_IBM_CREDITS - TOTAL_LENOVO) &lt; 1 THEN 'INVOICE VALIDATION PASSED ' ELSE 'INVOICE VALIDATION FAILED ' END AS VALIDATION,
		VALUE(TOTAL_IBM, 0) AS TOTAL_IBM,
		VALUE(TOTAL_IBM_CREDITS, 0) AS TOTAL_IBM_CREDITS,
		VALUE(TOTAL_LENOVO, 0) AS TOTAL_LENOVO,
		VALUE(TOTAL_IBM, 0) - VALUE(TOTAL_IBM_CREDITS, 0) - VALUE(TOTAL_LENOVO, 0) AS DIFFERENCE
		FROM TOTAL_LENOVO A LEFT JOIN TOTAL_IBM B ON A.KEY = B.KEY
                LEFT JOIN TOTAL_IBM_CREDITS C ON A.KEY = C.KEY
	"/>
      </subReport>
            
  </multiReport>    

</reports>
