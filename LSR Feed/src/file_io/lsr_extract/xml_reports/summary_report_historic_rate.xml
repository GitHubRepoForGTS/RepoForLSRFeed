<?xml version="1.0" encoding="UTF-8"?>

<!-- Modification History                            	 		-->
<!-- 08/17/2009 | VM | First Cut -->
<!-- 2009-12-23 | VM | Updated both parts areas to group the non transactional and transactional items together respectively -->


<!DOCTYPE reports SYSTEM "./../../dtd/LSRExtract.dtd">

<reports>
 
  <multiReport>
      <fileName text="lenovo_invoice_historic.csv" />
      <dateFormat text="MMMM dd yyyy" />
      <timeFormat text="HH:MM:SS" />

      <subReport includeHeader="Db2Header" includeTotals="N">
      	<SQL text="
      	
		SELECT 
		PERIOD_START_DTE AS BILL_PERIOD_START,
		PERIOD_END_DTE AS BILL_PERIOD_END
		FROM LENOVO.PERIOD_DATES WHERE PERIOD_END_DTE = (SELECT MAX(PERIOD_END_DTE) FROM LENOVO.PERIOD_DATES WHERE LEN_DATA_REC = 'Y' )
		
	"/>
      </subReport>


      <subReport includeHeader="Db2Header" includeTotals="Y">
      	<SQL text="
      	
		WITH SDW_COMPONENTS(SDW_COMP_ID) AS (
		SELECT SDW_COMP_ID FROM LENOVO.SDW_COMPONENTS WHERE LENOVO_INT = 'Y'
		),

		WW_CODE_REF(WW_CDE, US_BILL_GRP) AS (
		SELECT DISTINCT WW_CDE, US_BILL_GRP FROM LENOVO.WW_CODE_REF
		),
		
		CURRENT_WW_RATE(WW_CDE, BILLING_RATE) AS (
		  SELECT WW_CDE, BILLING_RATE FROM LENOVO.WW_CODE_REF WHERE (WW_CDE, END_DATE) IN ( 
		    SELECT WW_CDE, MAX(END_DATE)  FROM LENOVO.WW_CODE_REF WHERE RATE_LOOKUP = 'Y' AND (WW_CDE, END_DATE) NOT IN (
		      SELECT WW_CDE, MAX(END_DATE)  FROM LENOVO.WW_CODE_REF WHERE RATE_LOOKUP = 'Y' GROUP BY WW_CDE
		    ) GROUP BY WW_CDE
		  )
		),

		TARGET_PERIOD(PERIOD_END_DTE) AS (
		SELECT MAX(PERIOD_END_DTE) FROM LENOVO.PERIOD_DATES WHERE LEN_DATA_REC = 'Y'
		),

		SUB1 (WW_CDE, BILLING_RATE, TOTAL, AB, BC, MB, NB, NL, NT, NS, ON, PE, QC, SK, YT, OTHER) AS (
		SELECT WW_CDE, 
		SUM(BILLING_RATE * TRANSACTION_CNT) AS BILLING_RATE,
		VALUE(CAST(SUM(TRANSACTION_CNT) AS INTEGER), 0) AS TOTAL, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'ALBERTA' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS AB, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'BRITISH COLUMBIA' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS BC, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'MANITOBA' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS MB, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'NEW BRUNSWICK' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS NB, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'NEWFOUNDLAND' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS NL, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME IN ('N.W. TERRITORIES', 'NORTH WEST TERRITORIES', 'NORTHWEST TERRITORIES')  THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS NT, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'NOVA SCOTIA' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS NS,
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'ONTARIO' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS ON, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'PRINCE EDWARD ISLAND' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS PE, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'QUEBEC' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS QC, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME IN ('SASKATCHEWAN', 'SASKETCHEWAN') THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS SK, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'YUKON' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS YT,
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME NOT IN ('ALBERTA','BRITISH COLUMBIA','MANITOBA','NEW BRUNSWICK','NEWFOUNDLAND','N.W. TERRITORIES', 'NORTH WEST TERRITORIES', 'NORTHWEST TERRITORIES','NOVA SCOTIA','ONTARIO','PRINCE EDWARD ISLAND','QUEBEC','SASKATCHEWAN','SASKETCHEWAN','YUKON') THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS OTHER
		FROM LENOVO.BF_ALL_BYWW_V A
		WHERE EFFECTIVE_PERIOD IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 
		AND DETAIL_STATUS = 'APPROVED'
		AND COUNTRY_CDE = '649'
		AND SDW_COMP_ID NOT IN (SELECT SDW_COMP_ID FROM SDW_COMPONENTS)
		AND (WW_CDE, BILLING_RATE) IN (SELECT WW_CDE, BILLING_RATE FROM CURRENT_WW_RATE)
		GROUP BY WW_CDE

		UNION ALL

		SELECT WW_CDE, 
		SUM(BILLING_RATE * TRANSACTION_CNT) AS BILLING_RATE,
		VALUE(CAST(SUM(TRANSACTION_CNT) AS INTEGER), 0) AS TOTAL, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'ALBERTA' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS AB, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'BRITISH COLUMBIA' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS BC, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'MANITOBA' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS MB, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'NEW BRUNSWICK' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS NB, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'NEWFOUNDLAND' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS NL, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME IN ('N.W. TERRITORIES', 'NORTH WEST TERRITORIES', 'NORTHWEST TERRITORIES')  THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS NT, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'NOVA SCOTIA' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS NS,
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'ONTARIO' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS ON, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'PRINCE EDWARD ISLAND' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS PE, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'QUEBEC' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS QC, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME IN ('SASKATCHEWAN', 'SASKETCHEWAN') THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS SK, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'YUKON' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS YT,
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME NOT IN ('ALBERTA','BRITISH COLUMBIA','MANITOBA','NEW BRUNSWICK','NEWFOUNDLAND','N.W. TERRITORIES', 'NORTH WEST TERRITORIES', 'NORTHWEST TERRITORIES','NOVA SCOTIA','ONTARIO','PRINCE EDWARD ISLAND','QUEBEC','SASKATCHEWAN','SASKETCHEWAN','YUKON') THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS OTHER
		FROM LENOVO.DR_ALL_BYWW_V A
		WHERE EFFECTIVE_PERIOD IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 
		AND DETAIL_STATUS = 'APPROVED'
		AND COUNTRY_CDE = '649'
		AND SDW_COMP_ID NOT IN (SELECT SDW_COMP_ID FROM SDW_COMPONENTS)
		AND (WW_CDE, BILLING_RATE) IN (SELECT WW_CDE, BILLING_RATE FROM CURRENT_WW_RATE)
		GROUP BY WW_CDE

		UNION ALL

		SELECT WW_CDE, 
		SUM(BILLING_RATE * TRANSACTION_CNT) AS BILLING_RATE,
		VALUE(CAST(SUM(TRANSACTION_CNT) AS INTEGER), 0) AS TOTAL,
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'ALBERTA' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS AB, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'BRITISH COLUMBIA' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS BC, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'MANITOBA' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS MB, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'NEW BRUNSWICK' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS NB, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'NEWFOUNDLAND' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS NL, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME IN ('N.W. TERRITORIES', 'NORTH WEST TERRITORIES', 'NORTHWEST TERRITORIES')  THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS NT, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'NOVA SCOTIA' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS NS,
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'ONTARIO' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS ON, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'PRINCE EDWARD ISLAND' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS PE, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'QUEBEC' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS QC, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME IN ('SASKATCHEWAN', 'SASKETCHEWAN') THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS SK, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'YUKON' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS YT,
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME NOT IN ('ALBERTA','BRITISH COLUMBIA','MANITOBA','NEW BRUNSWICK','NEWFOUNDLAND','N.W. TERRITORIES', 'NORTH WEST TERRITORIES', 'NORTHWEST TERRITORIES','NOVA SCOTIA','ONTARIO','PRINCE EDWARD ISLAND','QUEBEC','SASKATCHEWAN','SASKETCHEWAN','YUKON') THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS OTHER
		FROM LENOVO.RCS_ALL_BYWW_V A
		WHERE EFFECTIVE_PERIOD IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 
		AND DETAIL_STATUS = 'APPROVED'
		AND COUNTRY_CDE = '649'
		AND SDW_COMP_ID NOT IN (SELECT SDW_COMP_ID FROM SDW_COMPONENTS)
		AND (WW_CDE, BILLING_RATE) IN (SELECT WW_CDE, BILLING_RATE FROM CURRENT_WW_RATE)
		GROUP BY WW_CDE
		)

		SELECT
		B.SDW_COMP_ID AS SDW_COMP_ID,
		C.US_BILL_GRP AS US_GROUP, 
		B.CDN_SDW_COMP_DESC AS BILL_DESCRIPTION, 
		SUM(A.BILLING_RATE) AS COMP_TOTAL, 
		SUM(A.TOTAL) AS TOTAL_TRX, 
		SUM(A.AB) AS AB, 
		SUM(A.BC) AS BC, 
		SUM(A.MB) AS MB, 
		SUM(A.NB) AS NB, 
		SUM(A.NL) AS NL, 
		SUM(A.NT)AS NT, 
		SUM(A.NS) AS NS, 
		SUM(A.ON) + SUM(OTHER) AS ON, 
		SUM(A.PE) AS PE, 
		SUM(A.QC) AS QC, 
		SUM(A.SK) AS SK, 
		SUM(A.YT) AS YT FROM SUB1 A LEFT JOIN LENOVO.SDW_COMPONENTS B ON A.WW_CDE = B.WW_CDE AND 'N' = B.LENOVO_INT 
		LEFT JOIN WW_CODE_REF C ON A.WW_CDE = C.WW_CDE
		GROUP BY B.SDW_COMP_ID, C.US_BILL_GRP, B.CDN_SDW_COMP_DESC ORDER BY B.SDW_COMP_ID

	"/>
      </subReport>

      <subReport includeHeader="None" includeTotals="Y">
	<SQL text="

                WITH SDW_COMPONENTS(SDW_COMP_ID) AS (
		SELECT SDW_COMP_ID FROM LENOVO.SDW_COMPONENTS WHERE LENOVO_INT = 'Y'
		),

		TARGET_PERIOD(PERIOD_END_DTE) AS (
		SELECT MAX(PERIOD_END_DTE) FROM LENOVO.PERIOD_DATES WHERE LEN_DATA_REC = 'Y'
		),
		
		WW_CODE_REF(WW_CDE, US_BILL_GRP, RATE_LOOKUP) AS (
		SELECT DISTINCT WW_CDE, US_BILL_GRP, RATE_LOOKUP FROM LENOVO.WW_CODE_REF
		),
		
		CURRENT_WW_RATE(WW_CDE, BILLING_RATE) AS (
		  SELECT WW_CDE, BILLING_RATE FROM LENOVO.WW_CODE_REF WHERE (WW_CDE, END_DATE) IN ( 
		    SELECT WW_CDE, MAX(END_DATE)  FROM LENOVO.WW_CODE_REF WHERE RATE_LOOKUP = 'Y' AND (WW_CDE, END_DATE) NOT IN (
		      SELECT WW_CDE, MAX(END_DATE)  FROM LENOVO.WW_CODE_REF WHERE RATE_LOOKUP = 'Y' GROUP BY WW_CDE
		    ) GROUP BY WW_CDE
		  )
		),

		SUB1 (WW_CDE, BILLING_RATE, TOTAL, AB, BC, MB, NB, NL, NT, NS, ON, PE, QC, SK, YT, OTHER) AS (
		SELECT WW_CDE, 
		SUM(BILLING_RATE * TRANSACTION_CNT) AS BILLING_RATE,
		VALUE(CAST(SUM(TRANSACTION_CNT) AS INTEGER), 0) AS TOTAL, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'ALBERTA' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS AB, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'BRITISH COLUMBIA' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS BC, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'MANITOBA' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS MB, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'NEW BRUNSWICK' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS NB, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'NEWFOUNDLAND' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS NL, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME IN ('N.W. TERRITORIES', 'NORTH WEST TERRITORIES', 'NORTHWEST TERRITORIES')  THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS NT, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'NOVA SCOTIA' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS NS,
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'ONTARIO' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS ON, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'PRINCE EDWARD ISLAND' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS PE, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'QUEBEC' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS QC, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME IN ('SASKATCHEWAN', 'SASKETCHEWAN') THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS SK, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'YUKON' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS YT,
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME NOT IN ('ALBERTA','BRITISH COLUMBIA','MANITOBA','NEW BRUNSWICK','NEWFOUNDLAND','N.W. TERRITORIES', 'NORTH WEST TERRITORIES', 'NORTHWEST TERRITORIES','NOVA SCOTIA','ONTARIO','PRINCE EDWARD ISLAND','QUEBEC','SASKATCHEWAN','SASKETCHEWAN','YUKON') THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS OTHER
		FROM LENOVO.PL_ALL_BYWW_V A
		WHERE EFFECTIVE_PERIOD IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 
		AND DETAIL_STATUS = 'APPROVED'
		AND COUNTRY_CDE = '649'
		AND SDW_COMP_ID NOT IN (SELECT SDW_COMP_ID FROM SDW_COMPONENTS)
		AND (WW_CDE, BILLING_RATE) IN (SELECT WW_CDE, BILLING_RATE FROM CURRENT_WW_RATE)
		GROUP BY WW_CDE
		),

		SUB2 (WW_CDE, SDW_COMP_ID, BILLING_RATE, TOTAL, AB, BC, MB, NB, NL, NT, NS, ON, PE, QC, SK, YT, OTHER) AS (		
		SELECT WW_CDE,
		SDW_COMP_ID,
		SUM(PART_COST) AS BILLING_RATE,
		VALUE(CAST(SUM(TRANSACTION_CNT) AS INTEGER), 0) AS TOTAL, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'ALBERTA' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS AB, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'BRITISH COLUMBIA' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS BC, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'MANITOBA' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS MB, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'NEW BRUNSWICK' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS NB, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'NEWFOUNDLAND' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS NL, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME IN ('N.W. TERRITORIES', 'NORTH WEST TERRITORIES', 'NORTHWEST TERRITORIES')  THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS NT, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'NOVA SCOTIA' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS NS,
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'ONTARIO' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS ON, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'PRINCE EDWARD ISLAND' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS PE, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'QUEBEC' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS QC, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME IN ('SASKATCHEWAN', 'SASKETCHEWAN') THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS SK, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'YUKON' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS YT,
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME NOT IN ('ALBERTA','BRITISH COLUMBIA','MANITOBA','NEW BRUNSWICK','NEWFOUNDLAND','N.W. TERRITORIES', 'NORTH WEST TERRITORIES', 'NORTHWEST TERRITORIES','NOVA SCOTIA','ONTARIO','PRINCE EDWARD ISLAND','QUEBEC','SASKATCHEWAN','SASKETCHEWAN','YUKON') THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS OTHER
		FROM LENOVO.PL_ALL_BYWW_V A
		WHERE EFFECTIVE_PERIOD IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 
		AND DETAIL_STATUS = 'APPROVED'
		AND COUNTRY_CDE = '649'
		AND SDW_COMP_ID NOT IN (SELECT SDW_COMP_ID FROM SDW_COMPONENTS)
		AND WW_CDE = '99'
		AND (WW_CDE, BILLING_RATE) IN (SELECT WW_CDE, BILLING_RATE FROM CURRENT_WW_RATE)
		GROUP BY WW_CDE, SDW_COMP_ID
		)

		SELECT B.SDW_COMP_ID, 
		C.US_BILL_GRP, 
		B.CDN_SDW_COMP_DESC,
		SUM(A.BILLING_RATE), 
		SUM(A.TOTAL), 
		SUM(A.AB), 
		SUM(A.BC), 
		SUM(A.MB), 
		SUM(A.NB), 
		SUM(A.NL), 
		SUM(A.NT), 
		SUM(A.NS), 
		SUM(A.ON) + SUM(A.OTHER), 
		SUM(A.PE), 
		SUM(A.QC), 
		SUM(A.SK), 
		SUM(A.YT) 
		FROM SUB1 A LEFT JOIN LENOVO.SDW_COMPONENTS B ON A.WW_CDE = B.WW_CDE AND 'N' = B.LENOVO_INT
		LEFT JOIN WW_CODE_REF C ON A.WW_CDE = C.WW_CDE
		WHERE RATE_LOOKUP = 'Y'
		AND A.WW_CDE NOT IN ('99')
		GROUP BY B.SDW_COMP_ID, C.US_BILL_GRP, B.CDN_SDW_COMP_DESC
		
		UNION ALL

		SELECT
		A.SDW_COMP_ID AS SDW_COMP_ID,
		'Parts Logistics and Management Services' AS US_GROUP,
		B.CDN_SDW_COMP_DESC AS BILL_DESCRIPTION, 
		SUM(A.BILLING_RATE) AS COMP_TOTAL, 
		SUM(A.TOTAL) AS TOTAL_TRX, 
		SUM(A.AB) AS AB, 
		SUM(A.BC) AS BC, 
		SUM(A.MB) AS MB, 
		SUM(A.NB) AS NB, 
		SUM(A.NL) AS NL, 
		SUM(A.NT)AS NT, 
		SUM(A.NS) AS NS, 
		SUM(A.ON) + SUM(OTHER) AS ON, 
		SUM(A.PE) AS PE, 
		SUM(A.QC) AS QC, 
		SUM(A.SK) AS SK, 
		SUM(A.YT) AS YT FROM SUB2 A LEFT JOIN LENOVO.SDW_COMPONENTS B ON A.SDW_COMP_ID = B.SDW_COMP_ID AND 'N' = B.LENOVO_INT 
		GROUP BY A.SDW_COMP_ID, B.CDN_SDW_COMP_DESC 
		
		ORDER BY SDW_COMP_ID
	"/>
      </subReport>

      <subReport includeHeader="None" includeTotals="N">
	<SQL text="

		WITH SDW_COMPONENTS(SDW_COMP_ID) AS (
		SELECT SDW_COMP_ID FROM LENOVO.SDW_COMPONENTS WHERE LENOVO_INT = 'Y'
		),

		CURRENT_WW_RATE(WW_CDE, BILLING_RATE) AS (
		  SELECT WW_CDE, BILLING_RATE FROM LENOVO.WW_CODE_REF WHERE (WW_CDE, END_DATE) IN ( 
		    SELECT WW_CDE, MAX(END_DATE)  FROM LENOVO.WW_CODE_REF WHERE RATE_LOOKUP = 'Y' AND (WW_CDE, END_DATE) NOT IN (
		      SELECT WW_CDE, MAX(END_DATE)  FROM LENOVO.WW_CODE_REF WHERE RATE_LOOKUP = 'Y' GROUP BY WW_CDE
		    ) GROUP BY WW_CDE
		  )
		),

		TARGET_PERIOD(PERIOD_END_DTE) AS (
		SELECT MAX(PERIOD_END_DTE) FROM LENOVO.PERIOD_DATES WHERE LEN_DATA_REC = 'Y'
		),

		PARTS_DIST(KEY, PARTS_DIST) AS 
		(
		SELECT 'PARTS', 
		VALUE(SUM(BILLING_RATE * TRANSACTION_CNT), 0) AS PARTS_DIST
		FROM LENOVO.PL_ALL_BYWW_V 
		WHERE EFFECTIVE_PERIOD IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 
		AND DETAIL_STATUS = 'APPROVED' 
		AND WW_CDE NOT IN('61', '60')
		AND SDW_COMP_ID NOT IN (SELECT SDW_COMP_ID FROM SDW_COMPONENTS)
		AND COUNTRY_CDE = '649'
		AND (WW_CDE, BILLING_RATE) IN (SELECT WW_CDE, BILLING_RATE FROM CURRENT_WW_RATE)
		),

		PARTS AS
		(
		SELECT VALUE(PARTS_DIST, 0)AS TOTAL_PARTS
		FROM PARTS_DIST
		),

		BF AS 
		(
		SELECT SUM(BILLING_RATE * TRANSACTION_CNT) AS TOTAL_BF
		FROM LENOVO.BF_ALL_BYWW_V A
		WHERE EFFECTIVE_PERIOD IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 
		AND DETAIL_STATUS = 'APPROVED'
		AND COUNTRY_CDE = '649'
		AND SDW_COMP_ID NOT IN (SELECT SDW_COMP_ID FROM SDW_COMPONENTS)
		AND (WW_CDE, BILLING_RATE) IN (SELECT WW_CDE, BILLING_RATE FROM CURRENT_WW_RATE)
		),

		RCS AS 
		(
		SELECT SUM(BILLING_RATE * TRANSACTION_CNT) AS TOTAL_RCS
		FROM LENOVO.RCS_ALL_BYWW_V A
		WHERE EFFECTIVE_PERIOD IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 
		AND DETAIL_STATUS = 'APPROVED'
		AND COUNTRY_CDE = '649'
		AND SDW_COMP_ID NOT IN (SELECT SDW_COMP_ID FROM SDW_COMPONENTS)
		AND (WW_CDE, BILLING_RATE) IN (SELECT WW_CDE, BILLING_RATE FROM CURRENT_WW_RATE)
		),

		DR AS 
		(
		SELECT SUM(BILLING_RATE * TRANSACTION_CNT) AS TOTAL_DR
		FROM LENOVO.DR_ALL_BYWW_V A
		WHERE EFFECTIVE_PERIOD IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 
		AND DETAIL_STATUS = 'APPROVED'
		AND COUNTRY_CDE = '649'
		AND SDW_COMP_ID NOT IN (SELECT SDW_COMP_ID FROM SDW_COMPONENTS)
		AND (WW_CDE, BILLING_RATE) IN (SELECT WW_CDE, BILLING_RATE FROM CURRENT_WW_RATE)
		),

		TOTAL_ALL AS 
		(
		SELECT TOTAL_PARTS AS TOTALS FROM PARTS
		UNION 
		SELECT TOTAL_RCS   AS TOTALS FROM RCS
		UNION
		SELECT TOTAL_BF   AS TOTALS FROM BF
		UNION
		SELECT TOTAL_DR   AS TOTALS FROM DR
		)

		SELECT '', '', 'NON LENOVO EMPLOYEE NET', VALUE(ROUND(SUM(TOTALS), 2),0) FROM TOTAL_ALL      
	"/>
      </subReport>

      <subReport includeHeader="None" includeTotals="N">
      	<SQL text=" 
      	
      	VALUES ('', 'LENOVO EMPLOYEE BILLING (TAXABLE)')
      	
      	"/>
      </subReport>


      <subReport includeHeader="Db2Header" includeTotals="Y">
      	<SQL text="

		WITH SDW_COMPONENTS(SDW_COMP_ID) AS (
		SELECT SDW_COMP_ID FROM LENOVO.SDW_COMPONENTS WHERE LENOVO_INT = 'N'
		),

		TARGET_PERIOD(PERIOD_END_DTE) AS (
		SELECT MAX(PERIOD_END_DTE) FROM LENOVO.PERIOD_DATES WHERE LEN_DATA_REC = 'Y'
		),

		WW_CODE_REF(WW_CDE, US_BILL_GRP) AS (
		SELECT DISTINCT WW_CDE, US_BILL_GRP FROM LENOVO.WW_CODE_REF
		),

		CURRENT_WW_RATE(WW_CDE, BILLING_RATE) AS (
		  SELECT WW_CDE, BILLING_RATE FROM LENOVO.WW_CODE_REF WHERE (WW_CDE, END_DATE) IN ( 
		    SELECT WW_CDE, MAX(END_DATE)  FROM LENOVO.WW_CODE_REF WHERE RATE_LOOKUP = 'Y' AND (WW_CDE, END_DATE) NOT IN (
		      SELECT WW_CDE, MAX(END_DATE)  FROM LENOVO.WW_CODE_REF WHERE RATE_LOOKUP = 'Y' GROUP BY WW_CDE
		    ) GROUP BY WW_CDE
		  )
		),

		SUB1 (WW_CDE, BILLING_RATE, TOTAL, AB, BC, MB, NB, NL, NT, NS, ON, PE, QC, SK, YT, OTHER) AS (
		SELECT WW_CDE, 
		SUM(BILLING_RATE * TRANSACTION_CNT) AS BILLING_RATE,
		VALUE(CAST(SUM(TRANSACTION_CNT) AS INTEGER), 0) AS TOTAL, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'ALBERTA' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS AB, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'BRITISH COLUMBIA' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS BC, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'MANITOBA' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS MB, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'NEW BRUNSWICK' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS NB, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'NEWFOUNDLAND' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS NL, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME IN ('N.W. TERRITORIES', 'NORTH WEST TERRITORIES', 'NORTHWEST TERRITORIES')  THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS NT, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'NOVA SCOTIA' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS NS,
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'ONTARIO' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS ON, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'PRINCE EDWARD ISLAND' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS PE, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'QUEBEC' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS QC, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME IN ('SASKATCHEWAN', 'SASKETCHEWAN') THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS SK, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'YUKON' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS YT,
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME NOT IN ('ALBERTA','BRITISH COLUMBIA','MANITOBA','NEW BRUNSWICK','NEWFOUNDLAND','N.W. TERRITORIES', 'NORTH WEST TERRITORIES', 'NORTHWEST TERRITORIES','NOVA SCOTIA','ONTARIO','PRINCE EDWARD ISLAND','QUEBEC','SASKATCHEWAN','SASKETCHEWAN','YUKON') THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS OTHER
		FROM LENOVO.BF_ALL_BYWW_V A
		WHERE EFFECTIVE_PERIOD IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 
		AND DETAIL_STATUS = 'APPROVED'
		AND COUNTRY_CDE = '649'
		AND SDW_COMP_ID NOT IN (SELECT SDW_COMP_ID FROM SDW_COMPONENTS)
		AND (WW_CDE, BILLING_RATE) IN (SELECT WW_CDE, BILLING_RATE FROM CURRENT_WW_RATE)
		GROUP BY WW_CDE

		UNION ALL

		SELECT WW_CDE, 
		SUM(BILLING_RATE * TRANSACTION_CNT) AS BILLING_RATE,
		VALUE(CAST(SUM(TRANSACTION_CNT) AS INTEGER), 0) AS TOTAL, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'ALBERTA' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS AB, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'BRITISH COLUMBIA' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS BC, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'MANITOBA' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS MB, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'NEW BRUNSWICK' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS NB, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'NEWFOUNDLAND' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS NL, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME IN ('N.W. TERRITORIES', 'NORTH WEST TERRITORIES', 'NORTHWEST TERRITORIES')  THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS NT, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'NOVA SCOTIA' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS NS,
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'ONTARIO' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS ON, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'PRINCE EDWARD ISLAND' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS PE, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'QUEBEC' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS QC, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME IN ('SASKATCHEWAN', 'SASKETCHEWAN') THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS SK, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'YUKON' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS YT,
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME NOT IN ('ALBERTA','BRITISH COLUMBIA','MANITOBA','NEW BRUNSWICK','NEWFOUNDLAND','N.W. TERRITORIES', 'NORTH WEST TERRITORIES', 'NORTHWEST TERRITORIES','NOVA SCOTIA','ONTARIO','PRINCE EDWARD ISLAND','QUEBEC','SASKATCHEWAN','SASKETCHEWAN','YUKON') THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS OTHER
		FROM LENOVO.DR_ALL_BYWW_V A
		WHERE EFFECTIVE_PERIOD IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 
		AND DETAIL_STATUS = 'APPROVED'
		AND COUNTRY_CDE = '649'
		AND SDW_COMP_ID NOT IN (SELECT SDW_COMP_ID FROM SDW_COMPONENTS)
		AND (WW_CDE, BILLING_RATE) IN (SELECT WW_CDE, BILLING_RATE FROM CURRENT_WW_RATE)
		GROUP BY WW_CDE

		UNION ALL

		SELECT WW_CDE, 
		SUM(BILLING_RATE * TRANSACTION_CNT) AS BILLING_RATE,
		VALUE(CAST(SUM(TRANSACTION_CNT) AS INTEGER), 0) AS TOTAL, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'ALBERTA' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS AB, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'BRITISH COLUMBIA' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS BC, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'MANITOBA' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS MB, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'NEW BRUNSWICK' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS NB, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'NEWFOUNDLAND' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS NL, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME IN ('N.W. TERRITORIES', 'NORTH WEST TERRITORIES', 'NORTHWEST TERRITORIES')  THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS NT, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'NOVA SCOTIA' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS NS,
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'ONTARIO' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS ON, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'PRINCE EDWARD ISLAND' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS PE, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'QUEBEC' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS QC, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME IN ('SASKATCHEWAN', 'SASKETCHEWAN') THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS SK, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'YUKON' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS YT,
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME NOT IN ('ALBERTA','BRITISH COLUMBIA','MANITOBA','NEW BRUNSWICK','NEWFOUNDLAND','N.W. TERRITORIES', 'NORTH WEST TERRITORIES', 'NORTHWEST TERRITORIES','NOVA SCOTIA','ONTARIO','PRINCE EDWARD ISLAND','QUEBEC','SASKATCHEWAN','SASKETCHEWAN','YUKON') THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS OTHER
		FROM LENOVO.RCS_ALL_BYWW_V A
		WHERE EFFECTIVE_PERIOD IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 
		AND DETAIL_STATUS = 'APPROVED'
		AND COUNTRY_CDE = '649'
		AND SDW_COMP_ID NOT IN (SELECT SDW_COMP_ID FROM SDW_COMPONENTS)
		AND (WW_CDE, BILLING_RATE) IN (SELECT WW_CDE, BILLING_RATE FROM CURRENT_WW_RATE)
		GROUP BY WW_CDE
		)

		SELECT 
		B.SDW_COMP_ID AS SDW_COMP_ID,
		C.US_BILL_GRP AS US_GROUP, 
		B.CDN_SDW_COMP_DESC AS BILL_DESCRIPTION, 
		SUM(A.BILLING_RATE) AS COMP_TOTAL, 
		SUM(A.TOTAL) AS TOTAL_TRX, 
		SUM(A.AB) AS AB, 
		SUM(A.BC) AS BC, 
		SUM(A.MB) AS MB, 
		SUM(A.NB) AS NB, 
		SUM(A.NL) AS NL, 
		SUM(A.NT)AS NT, 
		SUM(A.NS) AS NS, 
		SUM(A.ON) + SUM(OTHER) AS ON, 
		SUM(A.PE) AS PE, 
		SUM(A.QC) AS QC, 
		SUM(A.SK) AS SK, 
		SUM(A.YT) AS YT 
		FROM SUB1 A LEFT JOIN LENOVO.SDW_COMPONENTS B ON A.WW_CDE = B.WW_CDE AND 'Y' = B.LENOVO_INT 
		LEFT JOIN WW_CODE_REF C ON A.WW_CDE = C.WW_CDE
		GROUP BY B.SDW_COMP_ID, C.US_BILL_GRP, B.CDN_SDW_COMP_DESC ORDER BY B.SDW_COMP_ID

	"/>
      </subReport>
      
      <subReport includeHeader="None" includeTotals="Y">
	<SQL text="

		WITH SDW_COMPONENTS(SDW_COMP_ID) AS (
		SELECT SDW_COMP_ID FROM LENOVO.SDW_COMPONENTS WHERE LENOVO_INT = 'N'
		),

		WW_CODE_REF(WW_CDE, US_BILL_GRP, RATE_LOOKUP) AS (
		SELECT DISTINCT WW_CDE, US_BILL_GRP, RATE_LOOKUP FROM LENOVO.WW_CODE_REF
		),
		
		CURRENT_WW_RATE(WW_CDE, BILLING_RATE) AS (
		  SELECT WW_CDE, BILLING_RATE FROM LENOVO.WW_CODE_REF WHERE (WW_CDE, END_DATE) IN ( 
		    SELECT WW_CDE, MAX(END_DATE)  FROM LENOVO.WW_CODE_REF WHERE RATE_LOOKUP = 'Y' AND (WW_CDE, END_DATE) NOT IN (
		      SELECT WW_CDE, MAX(END_DATE)  FROM LENOVO.WW_CODE_REF WHERE RATE_LOOKUP = 'Y' GROUP BY WW_CDE
		    ) GROUP BY WW_CDE
		  )
		),

		TARGET_PERIOD(PERIOD_END_DTE) AS (
		SELECT MAX(PERIOD_END_DTE) FROM LENOVO.PERIOD_DATES WHERE LEN_DATA_REC = 'Y'
		),

		SUB1 (WW_CDE, BILLING_RATE, TOTAL, AB, BC, MB, NB, NL, NT, NS, ON, PE, QC, SK, YT, OTHER) AS (
		SELECT WW_CDE, 
		SUM(BILLING_RATE * TRANSACTION_CNT) AS BILLING_RATE,
		VALUE(CAST(SUM(TRANSACTION_CNT) AS INTEGER), 0) AS TOTAL, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'ALBERTA' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS AB, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'BRITISH COLUMBIA' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS BC, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'MANITOBA' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS MB, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'NEW BRUNSWICK' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS NB, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'NEWFOUNDLAND' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS NL, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME IN ('N.W. TERRITORIES', 'NORTH WEST TERRITORIES', 'NORTHWEST TERRITORIES')  THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS NT, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'NOVA SCOTIA' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS NS,
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'ONTARIO' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS ON, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'PRINCE EDWARD ISLAND' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS PE, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'QUEBEC' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS QC, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME IN ('SASKATCHEWAN', 'SASKETCHEWAN') THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS SK, 
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'YUKON' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS YT,
		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME NOT IN ('ALBERTA','BRITISH COLUMBIA','MANITOBA','NEW BRUNSWICK','NEWFOUNDLAND','N.W. TERRITORIES', 'NORTH WEST TERRITORIES', 'NORTHWEST TERRITORIES','NOVA SCOTIA','ONTARIO','PRINCE EDWARD ISLAND','QUEBEC','SASKATCHEWAN','SASKETCHEWAN','YUKON') THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS OTHER
		FROM LENOVO.PL_ALL_BYWW_V A
		WHERE EFFECTIVE_PERIOD IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 
		AND DETAIL_STATUS = 'APPROVED'
		AND COUNTRY_CDE = '649'
		AND SDW_COMP_ID NOT IN (SELECT SDW_COMP_ID FROM SDW_COMPONENTS)
		AND (WW_CDE, BILLING_RATE) IN (SELECT WW_CDE, BILLING_RATE FROM CURRENT_WW_RATE)
		GROUP BY WW_CDE
		)

		SELECT B.SDW_COMP_ID, C.US_BILL_GRP, B.CDN_SDW_COMP_DESC, SUM(A.BILLING_RATE), SUM(A.TOTAL), SUM(A.AB), SUM(A.BC), SUM(A.MB), SUM(A.NB), SUM(A.NL), SUM(A.NT), SUM(A.NS), SUM(A.ON) + SUM(A.OTHER), SUM(A.PE), SUM(A.QC), SUM(A.SK), SUM(A.YT) 
		FROM SUB1 A LEFT JOIN LENOVO.SDW_COMPONENTS B ON A.WW_CDE = B.WW_CDE AND 'Y' = B.LENOVO_INT
		LEFT JOIN WW_CODE_REF C ON A.WW_CDE = C.WW_CDE
		WHERE RATE_LOOKUP = 'Y'
		GROUP BY B.SDW_COMP_ID, C.US_BILL_GRP, B.CDN_SDW_COMP_DESC ORDER BY B.SDW_COMP_ID

	"/>
      </subReport>

      <subReport includeHeader="None" includeTotals="N">
	<SQL text="

		WITH SDW_COMPONENTS(SDW_COMP_ID) AS (
		SELECT SDW_COMP_ID FROM LENOVO.SDW_COMPONENTS WHERE LENOVO_INT = 'N'
		),

		CURRENT_WW_RATE(WW_CDE, BILLING_RATE) AS (
		  SELECT WW_CDE, BILLING_RATE FROM LENOVO.WW_CODE_REF WHERE (WW_CDE, END_DATE) IN ( 
		    SELECT WW_CDE, MAX(END_DATE)  FROM LENOVO.WW_CODE_REF WHERE RATE_LOOKUP = 'Y' AND (WW_CDE, END_DATE) NOT IN (
		      SELECT WW_CDE, MAX(END_DATE)  FROM LENOVO.WW_CODE_REF WHERE RATE_LOOKUP = 'Y' GROUP BY WW_CDE
		    ) GROUP BY WW_CDE
		  )
		),

		TARGET_PERIOD(PERIOD_END_DTE) AS (
		SELECT MAX(PERIOD_END_DTE) FROM LENOVO.PERIOD_DATES WHERE LEN_DATA_REC = 'Y'
		),

		PARTS_DIST(KEY, PARTS_DIST) AS 
		(
		SELECT 'PARTS', 
		VALUE(SUM(BILLING_RATE * TRANSACTION_CNT), 0) AS PARTS_DIST
		FROM LENOVO.PL_ALL_BYWW_V 
		WHERE EFFECTIVE_PERIOD IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 
		AND DETAIL_STATUS = 'APPROVED' 
		AND WW_CDE NOT IN('61', '60')
		AND SDW_COMP_ID NOT IN (SELECT SDW_COMP_ID FROM SDW_COMPONENTS)
		AND COUNTRY_CDE = '649'
		AND (WW_CDE, BILLING_RATE) IN (SELECT WW_CDE, BILLING_RATE FROM CURRENT_WW_RATE)
		),


		PARTS AS
		(
		SELECT VALUE(PARTS_DIST, 0) AS TOTAL_PARTS
		FROM PARTS_DIST
		),

		BF AS 
		(
		SELECT SUM(BILLING_RATE * TRANSACTION_CNT) AS TOTAL_BF
		FROM LENOVO.BF_ALL_BYWW_V A
		WHERE EFFECTIVE_PERIOD IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 
		AND DETAIL_STATUS = 'APPROVED'
		AND COUNTRY_CDE = '649'
		AND SDW_COMP_ID NOT IN (SELECT SDW_COMP_ID FROM SDW_COMPONENTS)
		AND (WW_CDE, BILLING_RATE) IN (SELECT WW_CDE, BILLING_RATE FROM CURRENT_WW_RATE)
		),

		RCS AS 
		(
		SELECT SUM(BILLING_RATE * TRANSACTION_CNT) AS TOTAL_RCS
		FROM LENOVO.RCS_ALL_BYWW_V A
		WHERE EFFECTIVE_PERIOD IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 
		AND DETAIL_STATUS = 'APPROVED'
		AND COUNTRY_CDE = '649'
		AND SDW_COMP_ID NOT IN (SELECT SDW_COMP_ID FROM SDW_COMPONENTS)
		AND (WW_CDE, BILLING_RATE) IN (SELECT WW_CDE, BILLING_RATE FROM CURRENT_WW_RATE)
		),

		DR AS 
		(
		SELECT SUM(BILLING_RATE * TRANSACTION_CNT) AS TOTAL_DR
		FROM LENOVO.DR_ALL_BYWW_V A
		WHERE EFFECTIVE_PERIOD IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 
		AND DETAIL_STATUS = 'APPROVED'
		AND COUNTRY_CDE = '649'
		AND SDW_COMP_ID NOT IN (SELECT SDW_COMP_ID FROM SDW_COMPONENTS)
		AND (WW_CDE, BILLING_RATE) IN (SELECT WW_CDE, BILLING_RATE FROM CURRENT_WW_RATE)
		),

		TOTAL_ALL AS 
		(
		SELECT TOTAL_PARTS  AS TOTALS FROM PARTS 
		UNION 
		SELECT TOTAL_RCS   AS TOTALS FROM RCS
		UNION
		SELECT TOTAL_BF   AS TOTALS FROM BF
		UNION
		SELECT TOTAL_DR   AS TOTALS FROM DR
		)

		SELECT '', '', 'LENOVO EMPLOYEE NET', VALUE(ROUND(SUM(TOTALS), 2),0) FROM TOTAL_ALL

	"/>
      </subReport>


     <subReport includeHeader="None" includeTotals="N">
	<SQL text="
	
		WITH TARGET_PERIOD(PERIOD_END_DTE) AS (
		SELECT MAX(PERIOD_END_DTE) FROM LENOVO.PERIOD_DATES WHERE LEN_DATA_REC = 'Y'
		),
		
		CURRENT_WW_RATE(WW_CDE, BILLING_RATE) AS (
		  SELECT WW_CDE, BILLING_RATE FROM LENOVO.WW_CODE_REF WHERE (WW_CDE, END_DATE) IN ( 
		    SELECT WW_CDE, MAX(END_DATE)  FROM LENOVO.WW_CODE_REF WHERE RATE_LOOKUP = 'Y' AND (WW_CDE, END_DATE) NOT IN (
		      SELECT WW_CDE, MAX(END_DATE)  FROM LENOVO.WW_CODE_REF WHERE RATE_LOOKUP = 'Y' GROUP BY WW_CDE
		    ) GROUP BY WW_CDE
		  )
		),

		PARTS_DIST(KEY, PARTS_DIST) AS 
		(
		SELECT 'PARTS', 
		VALUE(SUM(BILLING_RATE * TRANSACTION_CNT), 0) AS PARTS_DIST
		FROM LENOVO.PL_ALL_BYWW_V 
		WHERE EFFECTIVE_PERIOD IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 
		AND DETAIL_STATUS = 'APPROVED' 
		AND WW_CDE NOT IN('61', '60')
		AND COUNTRY_CDE = '649'
		AND (WW_CDE, BILLING_RATE) IN (SELECT WW_CDE, BILLING_RATE FROM CURRENT_WW_RATE)
		),

		PARTS AS
		(
		SELECT VALUE(PARTS_DIST, 0) AS TOTAL_PARTS
		FROM PARTS_DIST
		),

		BF AS 
		(
		SELECT SUM(BILLING_RATE * TRANSACTION_CNT) AS TOTAL_BF
		FROM LENOVO.BF_ALL_BYWW_V A
		WHERE EFFECTIVE_PERIOD IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 
		AND DETAIL_STATUS = 'APPROVED'
		AND COUNTRY_CDE = '649'
		AND (WW_CDE, BILLING_RATE) IN (SELECT WW_CDE, BILLING_RATE FROM CURRENT_WW_RATE)
		),

		RCS AS 
		(
		SELECT SUM(BILLING_RATE * TRANSACTION_CNT) AS TOTAL_RCS
		FROM LENOVO.RCS_ALL_BYWW_V A
		WHERE EFFECTIVE_PERIOD IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 
		AND DETAIL_STATUS = 'APPROVED'
		AND COUNTRY_CDE = '649'
		AND (WW_CDE, BILLING_RATE) IN (SELECT WW_CDE, BILLING_RATE FROM CURRENT_WW_RATE)
		),

		DR AS 
		(
		SELECT SUM(BILLING_RATE * TRANSACTION_CNT) AS TOTAL_DR
		FROM LENOVO.DR_ALL_BYWW_V A
		WHERE EFFECTIVE_PERIOD IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 
		AND DETAIL_STATUS = 'APPROVED'
		AND COUNTRY_CDE = '649'
		AND (WW_CDE, BILLING_RATE) IN (SELECT WW_CDE, BILLING_RATE FROM CURRENT_WW_RATE)
		),

		TOTAL_ALL AS 
		(
		SELECT TOTAL_PARTS  AS TOTALS FROM PARTS 
		UNION 
		SELECT TOTAL_RCS   AS TOTALS FROM RCS
		UNION
		SELECT TOTAL_BF   AS TOTALS FROM BF
		UNION
		SELECT TOTAL_DR   AS TOTALS FROM DR
		)

		SELECT '', '', 'INVOICE TOTAL', VALUE(ROUND(SUM(TOTALS), 2),0) FROM TOTAL_ALL

	"/>
      </subReport>

      
  </multiReport>    

</reports>
