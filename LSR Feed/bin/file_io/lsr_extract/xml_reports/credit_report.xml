<?xml version="1.0" encoding="UTF-8"?>



<!--                                                 -->

<!--    Break-fix - Report SQLs DTD and XML          -->

<!--                                                 -->



<!-- Modification History                            	 		-->

<!-- 07/15/2008 | VM | First Cut					-->

<!-- 2009-05-01 | VM | Added capability to account for a Parts Management Feed Credit.   remove '003' to undo this-->

<!-- 2009-08-17 | VM | C3949 New set of billing tables.  Updated target period to use new LEN_DATA_REC flag -->

<!-- 2009-12-07 | VM | Added 001 code for transaction reversals -->

<!-- 2009-12-23 | VM | Updated both parts areas to group the non transactional and transactional items together respectively -->

<!-- 2010-08-13 | VM | Changed the output file name to include GST-->

<!-- 2010-09-20 | VM | This report modifed to pull HST taxable services only -->

<!-- 2010-09-20 | VM | Added credit code 004 -->

<!-- 2010-11-16 | VM | Removed service date check for GST HST split-->



<!DOCTYPE reports SYSTEM "./../../dtd/LSRExtract.dtd">



<reports>

 

  <multiReport>

      <fileName text="lenovo_credit_invoice.csv" />

      <dateFormat text="yyyy-mm-dd" />

      <timeFormat text="HH:MM:SS" />



      <subReport includeHeader="Db2Header" includeTotals="N">

      	<SQL text="

      	

		SELECT 

		PERIOD_START_DTE AS BILL_PERIOD_START,

		PERIOD_END_DTE AS BILL_PERIOD_END

		FROM LENOVO.PERIOD_DATES WHERE PERIOD_END_DTE = (SELECT MAX(PERIOD_END_DTE) FROM LENOVO.PERIOD_DATES WHERE LEN_DATA_REC = 'Y' )



	"/>

      </subReport>





      <subReport includeHeader="Db2Header" includeTotals="Y">

      	<SQL text="

      	

		WITH SDW_COMPONENTS(SDW_COMP_ID) AS (

		SELECT SDW_COMP_ID FROM LENOVO.SDW_COMPONENTS WHERE LENOVO_INT = 'Y'

		),



		WW_CODE_REF(WW_CDE, US_BILL_GRP) AS (

		SELECT DISTINCT WW_CDE, US_BILL_GRP FROM LENOVO.WW_CODE_REF

		),



		TARGET_PERIOD(PERIOD_END_DTE) AS (

		SELECT MAX(PERIOD_END_DTE) FROM LENOVO.PERIOD_DATES WHERE LEN_DATA_REC = 'Y'

		),



		SUB1 (WW_CDE, BILLING_RATE, TOTAL, AB, BC, MB, NB, NL, NT, NS, ON, PE, QC, SK, YT, OTHER) AS (

		SELECT WW_CDE, 

		SUM(BILLING_RATE * TRANSACTION_CNT) AS BILLING_RATE,

		VALUE(CAST(SUM(TRANSACTION_CNT) AS INTEGER), 0) AS TOTAL, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'ALBERTA' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS AB, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'BRITISH COLUMBIA' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS BC, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'MANITOBA' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS MB, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'NEW BRUNSWICK' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS NB, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'NEWFOUNDLAND' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS NL, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME IN ('N.W. TERRITORIES', 'NORTH WEST TERRITORIES', 'NORTHWEST TERRITORIES')  THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS NT, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'NOVA SCOTIA' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS NS,

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'ONTARIO' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS ON, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'PRINCE EDWARD ISLAND' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS PE, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'QUEBEC' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS QC, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME IN ('SASKATCHEWAN', 'SASKETCHEWAN') THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS SK, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'YUKON' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS YT,

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME NOT IN ('ALBERTA','BRITISH COLUMBIA','MANITOBA','NEW BRUNSWICK','NEWFOUNDLAND','N.W. TERRITORIES', 'NORTH WEST TERRITORIES', 'NORTHWEST TERRITORIES','NOVA SCOTIA','ONTARIO','PRINCE EDWARD ISLAND','QUEBEC','SASKATCHEWAN','SASKETCHEWAN','YUKON') THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS OTHER

		FROM LENOVO.BF_DETAIL_CR A

		WHERE PERIOD_END_DTE  IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 

		AND STATUS = 'CREDIT'

		AND COUNTRY_CDE = '649'

		AND CREDIT_CDE IN ('001', '002', '004')

		AND SDW_COMP_ID NOT IN (SELECT SDW_COMP_ID FROM SDW_COMPONENTS)

		GROUP BY WW_CDE



		UNION ALL



		SELECT WW_CDE, 

		SUM(BILLING_RATE * TRANSACTION_CNT) AS BILLING_RATE,

		VALUE(CAST(SUM(TRANSACTION_CNT) AS INTEGER), 0) AS TOTAL, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'ALBERTA' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS AB, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'BRITISH COLUMBIA' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS BC, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'MANITOBA' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS MB, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'NEW BRUNSWICK' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS NB, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'NEWFOUNDLAND' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS NL, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME IN ('N.W. TERRITORIES', 'NORTH WEST TERRITORIES', 'NORTHWEST TERRITORIES')  THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS NT, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'NOVA SCOTIA' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS NS,

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'ONTARIO' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS ON, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'PRINCE EDWARD ISLAND' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS PE, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'QUEBEC' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS QC, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME IN ('SASKATCHEWAN', 'SASKETCHEWAN') THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS SK, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'YUKON' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS YT,

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME NOT IN ('ALBERTA','BRITISH COLUMBIA','MANITOBA','NEW BRUNSWICK','NEWFOUNDLAND','N.W. TERRITORIES', 'NORTH WEST TERRITORIES', 'NORTHWEST TERRITORIES','NOVA SCOTIA','ONTARIO','PRINCE EDWARD ISLAND','QUEBEC','SASKATCHEWAN','SASKETCHEWAN','YUKON') THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS OTHER

		FROM LENOVO.DR_DETAIL_CR A

		WHERE PERIOD_END_DTE IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 

		AND STATUS = 'CREDIT'

		AND COUNTRY_CDE = '649'

		AND CREDIT_CDE IN ('001', '002', '004')

		AND SDW_COMP_ID NOT IN (SELECT SDW_COMP_ID FROM SDW_COMPONENTS)

		GROUP BY WW_CDE



		UNION ALL



		SELECT WW_CDE, 

		SUM(BILLING_RATE * TRANSACTION_CNT) AS BILLING_RATE,

		VALUE(CAST(SUM(TRANSACTION_CNT) AS INTEGER), 0) AS TOTAL,

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'ALBERTA' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS AB, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'BRITISH COLUMBIA' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS BC, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'MANITOBA' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS MB, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'NEW BRUNSWICK' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS NB, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'NEWFOUNDLAND' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS NL, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME IN ('N.W. TERRITORIES', 'NORTH WEST TERRITORIES', 'NORTHWEST TERRITORIES')  THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS NT, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'NOVA SCOTIA' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS NS,

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'ONTARIO' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS ON, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'PRINCE EDWARD ISLAND' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS PE, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'QUEBEC' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS QC, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME IN ('SASKATCHEWAN', 'SASKETCHEWAN') THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS SK, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'YUKON' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS YT,

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME NOT IN ('ALBERTA','BRITISH COLUMBIA','MANITOBA','NEW BRUNSWICK','NEWFOUNDLAND','N.W. TERRITORIES', 'NORTH WEST TERRITORIES', 'NORTHWEST TERRITORIES','NOVA SCOTIA','ONTARIO','PRINCE EDWARD ISLAND','QUEBEC','SASKATCHEWAN','SASKETCHEWAN','YUKON') THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS OTHER

		FROM LENOVO.RCS_DETAIL_CR A

		WHERE PERIOD_END_DTE IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 

		AND STATUS = 'CREDIT'

		AND COUNTRY_CDE = '649'

		AND CREDIT_CDE IN ('001', '002', '004')

		AND SDW_COMP_ID NOT IN (SELECT SDW_COMP_ID FROM SDW_COMPONENTS)

		GROUP BY WW_CDE

		)



		SELECT

		B.SDW_COMP_ID AS SDW_COMP_ID,

		C.US_BILL_GRP AS US_GROUP, 

		B.CDN_SDW_COMP_DESC AS BILL_DESCRIPTION, 

		SUM(A.BILLING_RATE) AS COMP_TOTAL, 

		SUM(A.TOTAL) AS TOTAL_TRX, 

		SUM(A.AB) AS AB, 

		SUM(A.BC) AS BC, 

		SUM(A.MB) AS MB, 

		SUM(A.NB) AS NB, 

		SUM(A.NL) AS NL, 

		SUM(A.NT)AS NT, 

		SUM(A.NS) AS NS, 

		SUM(A.ON) + SUM(OTHER) AS ON, 

		SUM(A.PE) AS PE, 

		SUM(A.QC) AS QC, 

		SUM(A.SK) AS SK, 

		SUM(A.YT) AS YT FROM SUB1 A LEFT JOIN LENOVO.SDW_COMPONENTS B ON A.WW_CDE = B.WW_CDE AND 'N' = B.LENOVO_INT 

		LEFT JOIN WW_CODE_REF C ON A.WW_CDE = C.WW_CDE

		GROUP BY B.SDW_COMP_ID, C.US_BILL_GRP, B.CDN_SDW_COMP_DESC ORDER BY B.SDW_COMP_ID

	"/>

      </subReport>



      <subReport includeHeader="None" includeTotals="Y">

	<SQL text="



		WITH SDW_COMPONENTS(SDW_COMP_ID) AS (

		SELECT SDW_COMP_ID FROM LENOVO.SDW_COMPONENTS WHERE LENOVO_INT = 'Y'

		),



		WW_CODE_REF(WW_CDE, US_BILL_GRP, RATE_LOOKUP) AS (

		SELECT DISTINCT WW_CDE, US_BILL_GRP, RATE_LOOKUP FROM LENOVO.WW_CODE_REF

		),



		TARGET_PERIOD(PERIOD_END_DTE) AS (

		SELECT MAX(PERIOD_END_DTE) FROM LENOVO.PERIOD_DATES WHERE LEN_DATA_REC = 'Y'

		),



		SUB1 (WW_CDE, BILLING_RATE, TOTAL, AB, BC, MB, NB, NL, NT, NS, ON, PE, QC, SK, YT, OTHER) AS (

		SELECT WW_CDE, 

		SUM(BILLING_RATE * TRANSACTION_CNT) AS BILLING_RATE,

		VALUE(CAST(SUM(TRANSACTION_CNT) AS INTEGER), 0) AS TOTAL, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'ALBERTA' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS AB, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'BRITISH COLUMBIA' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS BC, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'MANITOBA' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS MB, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'NEW BRUNSWICK' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS NB, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'NEWFOUNDLAND' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS NL, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME IN ('N.W. TERRITORIES', 'NORTH WEST TERRITORIES', 'NORTHWEST TERRITORIES')  THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS NT, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'NOVA SCOTIA' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS NS,

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'ONTARIO' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS ON, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'PRINCE EDWARD ISLAND' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS PE, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'QUEBEC' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS QC, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME IN ('SASKATCHEWAN', 'SASKETCHEWAN') THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS SK, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'YUKON' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS YT,

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME NOT IN ('ALBERTA','BRITISH COLUMBIA','MANITOBA','NEW BRUNSWICK','NEWFOUNDLAND','N.W. TERRITORIES', 'NORTH WEST TERRITORIES', 'NORTHWEST TERRITORIES','NOVA SCOTIA','ONTARIO','PRINCE EDWARD ISLAND','QUEBEC','SASKATCHEWAN','SASKETCHEWAN','YUKON') THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS OTHER

		FROM LENOVO.PL_DETAIL_CR A

		WHERE PERIOD_END_DTE IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 

		AND STATUS = 'CREDIT'

		AND COUNTRY_CDE = '649'

		AND CREDIT_CDE IN ('001', '002', '004')

		AND SDW_COMP_ID NOT IN (SELECT SDW_COMP_ID FROM SDW_COMPONENTS)

		GROUP BY WW_CDE

		)



		SELECT B.SDW_COMP_ID, C.US_BILL_GRP, B.CDN_SDW_COMP_DESC, SUM(A.BILLING_RATE), SUM(A.TOTAL), SUM(A.AB), SUM(A.BC), SUM(A.MB), SUM(A.NB), SUM(A.NL), SUM(A.NT), SUM(A.NS), SUM(A.ON) + SUM(A.OTHER), SUM(A.PE), SUM(A.QC), SUM(A.SK), SUM(A.YT) 

		FROM SUB1 A LEFT JOIN LENOVO.SDW_COMPONENTS B ON A.WW_CDE = B.WW_CDE AND 'N' = B.LENOVO_INT

		LEFT JOIN WW_CODE_REF C ON A.WW_CDE = C.WW_CDE

		WHERE RATE_LOOKUP = 'Y'

		GROUP BY B.SDW_COMP_ID, C.US_BILL_GRP, B.CDN_SDW_COMP_DESC ORDER BY B.SDW_COMP_ID



	"/>

      </subReport>



      <subReport includeHeader="None" includeTotals="Y">

	<SQL text="



		WITH SDW_COMPONENTS(SDW_COMP_ID) AS (

		SELECT SDW_COMP_ID FROM LENOVO.SDW_COMPONENTS WHERE LENOVO_INT = 'Y'

		),



		WW_CODE_REF(WW_CDE, US_BILL_GRP, RATE_LOOKUP) AS (

		SELECT DISTINCT WW_CDE, US_BILL_GRP, RATE_LOOKUP FROM LENOVO.WW_CODE_REF

		),



		TARGET_PERIOD(PERIOD_END_DTE) AS (

		SELECT MAX(PERIOD_END_DTE) FROM LENOVO.PERIOD_DATES WHERE LEN_DATA_REC = 'Y'

		),



		PARTS_CREDIT(SDW_COMP_ID, PARTS_CREDIT) AS (

		SELECT 'C0001296' AS SDW_COMP_ID, CAST(VALUE(SUM(PART_CREDIT),0)AS DECIMAL(15,7)) AS PARTS_CREDIT 

		FROM LENOVO.PL_DETAIL_CR 

		WHERE PERIOD_END_DTE IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 

		AND STATUS = 'CREDIT' AND WW_CDE = '61' AND CREDIT_CDE IN ('001', '002', '004') AND SDW_COMP_ID NOT IN (SELECT SDW_COMP_ID FROM SDW_COMPONENTS)

		AND COUNTRY_CDE = '649'

		),



		SUB1 (WW_CDE, BILLING_RATE, TOTAL, AB, BC, MB, NB, NL, NT, NS, ON, PE, QC, SK, YT,OTHER) AS (

		SELECT WW_CDE, 

		SUM(PART_COST) AS BILLING_RATE,

		0 AS  TOTAL,

		VALUE(SUM(CASE WHEN PROVINCE_NAME = 'ALBERTA' THEN PART_COST END), 0) AS AB, 

		VALUE(SUM(CASE WHEN PROVINCE_NAME = 'BRITISH COLUMBIA' THEN PART_COST END), 0) AS BC, 

		VALUE(SUM(CASE WHEN PROVINCE_NAME = 'MANITOBA' THEN PART_COST END), 0) AS MB, 

		VALUE(SUM(CASE WHEN PROVINCE_NAME = 'NEW BRUNSWICK' THEN PART_COST END), 0) AS NB, 

		VALUE(SUM(CASE WHEN PROVINCE_NAME = 'NEWFOUNDLAND' THEN PART_COST END), 0) AS NL, 

		VALUE(SUM(CASE WHEN PROVINCE_NAME IN ('N.W. TERRITORIES', 'NORTH WEST TERRITORIES', 'NORTHWEST TERRITORIES')  THEN PART_COST END), 0) AS NT, 

		VALUE(SUM(CASE WHEN PROVINCE_NAME = 'NOVA SCOTIA' THEN PART_COST END), 0) AS NS,

		VALUE(SUM(CASE WHEN PROVINCE_NAME = 'ONTARIO' THEN PART_COST END), 0) AS ON, 

		VALUE(SUM(CASE WHEN PROVINCE_NAME = 'PRINCE EDWARD ISLAND' THEN PART_COST END), 0) AS PE, 

		VALUE(SUM(CASE WHEN PROVINCE_NAME = 'QUEBEC' THEN PART_COST END), 0) AS QC, 

		VALUE(SUM(CASE WHEN PROVINCE_NAME IN ('SASKATCHEWAN', 'SASKETCHEWAN') THEN PART_COST END), 0) AS SK, 

		VALUE(SUM(CASE WHEN PROVINCE_NAME = 'YUKON' THEN PART_COST END), 0) AS YT,

		VALUE(SUM(CASE WHEN PROVINCE_NAME NOT IN ('ALBERTA','BRITISH COLUMBIA','MANITOBA','NEW BRUNSWICK','NEWFOUNDLAND','N.W. TERRITORIES', 'NORTH WEST TERRITORIES', 'NORTHWEST TERRITORIES','NOVA SCOTIA','ONTARIO','PRINCE EDWARD ISLAND','QUEBEC','SASKATCHEWAN', 'SASKETCHEWAN','YUKON') THEN PART_COST END), 0) AS OTHER

		FROM LENOVO.PL_DETAIL_CR A

		WHERE PERIOD_END_DTE IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 

		AND STATUS = 'CREDIT'

		AND COUNTRY_CDE = '649'

		AND CREDIT_CDE IN ('001', '002', '004', '003')

		AND SDW_COMP_ID NOT IN (SELECT SDW_COMP_ID FROM SDW_COMPONENTS)

		GROUP BY WW_CDE

		),



		SUB2 (SDW_COMP_ID, US_BILL_GRP, CDN_SDW_COMP_DESC, BILLING_RATE, TOTAL, AB, BC, MB, NB, NL, NT, NS, ON, PE, QC, SK, YT)  AS (

		SELECT B.SDW_COMP_ID,

		C.US_BILL_GRP,  

		B.CDN_SDW_COMP_DESC,

		CAST (SUM(A.BILLING_RATE) AS DECIMAL(15,7)),

		CAST (SUM(A.TOTAL) AS DECIMAL(15,7)),

		CAST (SUM(A.AB) AS DECIMAL(15,7)),

		CAST (SUM(A.BC) AS DECIMAL(15,7)),

		CAST (SUM(A.MB) AS DECIMAL(15,7)),

		CAST (SUM(A.NB) AS DECIMAL(15,7)),

		CAST (SUM(A.NL) AS DECIMAL(15,7)),

		CAST (SUM(A.NT) AS DECIMAL(15,7)),

		CAST (SUM(A.NS) AS DECIMAL(15,7)),

		CAST (VALUE(SUM(A.ON), 0) + VALUE(SUM(A.OTHER), 0) AS DECIMAL(15,7)),

		CAST (SUM(A.PE) AS DECIMAL(15,7)),

		CAST (SUM(A.QC) AS DECIMAL(15,7)),

		CAST (SUM(A.SK) AS DECIMAL(15,7)),

		CAST (SUM(A.YT) AS DECIMAL(15,7))

		FROM SUB1 A LEFT JOIN LENOVO.SDW_COMPONENTS B ON A.WW_CDE = B.WW_CDE AND 'N' = B.LENOVO_INT

		LEFT JOIN WW_CODE_REF C ON A.WW_CDE = C.WW_CDE

		GROUP BY B.SDW_COMP_ID, C.US_BILL_GRP, B.CDN_SDW_COMP_DESC

		),



		FINAL_RESULT (SDW_COMP_ID, US_BILL_GRP, CDN_SDW_COMP_DESC, BILLING_RATE, TOTAL, AB, BC, MB, NB, NL, NT, NS, ON, PE, QC, SK, YT)  AS (

		SELECT 

		B.SDW_COMP_ID, 

		C.US_BILL_GRP,

		B.CDN_SDW_COMP_DESC,

		ROUND(SUM(A.BILLING_RATE), 2),

		ROUND(SUM(A.TOTAL), 2),

		ROUND(SUM(A.AB), 2), 

		ROUND(SUM(A.BC), 2),

		ROUND(SUM(A.MB), 2),

		ROUND(SUM(A.NB), 2),

		ROUND(SUM(A.NL), 2),

		ROUND(SUM(A.NT), 2),

		ROUND(SUM(A.NS), 2),

		ROUND(SUM(A.ON) + SUM(A.OTHER), 2) AS ON,

		ROUND(SUM(A.PE), 2),

		ROUND(SUM(A.QC), 2),

		ROUND(SUM(A.SK), 2),

		ROUND(SUM(A.YT), 2)

		FROM SUB1 A LEFT JOIN LENOVO.SDW_COMPONENTS B ON A.WW_CDE = B.WW_CDE AND 'N' = B.LENOVO_INT

		LEFT JOIN WW_CODE_REF C ON A.WW_CDE = C.WW_CDE

		WHERE B.SDW_COMP_ID NOT IN ('C0001296', 'C0001297')

		AND RATE_LOOKUP = 'N'

		GROUP BY B.SDW_COMP_ID, C.US_BILL_GRP, B.CDN_SDW_COMP_DESC



		UNION ALL



		SELECT 

		A.SDW_COMP_ID,

		A.US_BILL_GRP,

		A.CDN_SDW_COMP_DESC,

		ROUND(CASE WHEN A.SDW_COMP_ID = 'C0001296' THEN A.BILLING_RATE - C.PARTS_CREDIT ELSE A.BILLING_RATE END, 2) AS BILLING_RATE,

		ROUND(A.TOTAL, 2),

		ROUND(VALUE(CASE WHEN C.PARTS_CREDIT = 0 THEN AB ELSE CASE WHEN A.SDW_COMP_ID = 'C0001296' THEN AB - C.PARTS_CREDIT * AB / A.BILLING_RATE ELSE AB END END, 0), 2) AS AB,

		ROUND(VALUE(CASE WHEN C.PARTS_CREDIT = 0 THEN BC ELSE CASE WHEN A.SDW_COMP_ID = 'C0001296' THEN BC - C.PARTS_CREDIT * BC / A.BILLING_RATE ELSE BC END END, 0), 2) AS BC,

		ROUND(VALUE(CASE WHEN C.PARTS_CREDIT = 0 THEN MB ELSE CASE WHEN A.SDW_COMP_ID = 'C0001296' THEN MB - C.PARTS_CREDIT * MB / A.BILLING_RATE ELSE MB END END, 0), 2) AS MB,

		ROUND(VALUE(CASE WHEN C.PARTS_CREDIT = 0 THEN NB ELSE CASE WHEN A.SDW_COMP_ID = 'C0001296' THEN NB - C.PARTS_CREDIT * NB / A.BILLING_RATE ELSE NB END END, 0), 2) AS NB,

		ROUND(VALUE(CASE WHEN C.PARTS_CREDIT = 0 THEN NL ELSE CASE WHEN A.SDW_COMP_ID = 'C0001296' THEN NL - C.PARTS_CREDIT * NL / A.BILLING_RATE ELSE NL END END, 0), 2) AS NL,

		ROUND(VALUE(CASE WHEN C.PARTS_CREDIT = 0 THEN NT ELSE CASE WHEN A.SDW_COMP_ID = 'C0001296' THEN NT - C.PARTS_CREDIT * NT / A.BILLING_RATE ELSE NT END END, 0), 2) AS NT,

		ROUND(VALUE(CASE WHEN C.PARTS_CREDIT = 0 THEN NS ELSE CASE WHEN A.SDW_COMP_ID = 'C0001296' THEN NS - C.PARTS_CREDIT * NS / A.BILLING_RATE ELSE NS END END, 0), 2) AS NS,

		ROUND(VALUE(CASE WHEN C.PARTS_CREDIT = 0 THEN ON ELSE CASE WHEN A.SDW_COMP_ID = 'C0001296' THEN ON - C.PARTS_CREDIT * ON / A.BILLING_RATE ELSE ON END END, 0), 2) AS ON,

		ROUND(VALUE(CASE WHEN C.PARTS_CREDIT = 0 THEN PE ELSE CASE WHEN A.SDW_COMP_ID = 'C0001296' THEN PE - C.PARTS_CREDIT * PE / A.BILLING_RATE ELSE PE END END, 0), 2) AS PE,

		ROUND(VALUE(CASE WHEN C.PARTS_CREDIT = 0 THEN QC ELSE CASE WHEN A.SDW_COMP_ID = 'C0001296' THEN QC - C.PARTS_CREDIT * QC / A.BILLING_RATE ELSE QC END END, 0), 2) AS QC,

		ROUND(VALUE(CASE WHEN C.PARTS_CREDIT = 0 THEN SK ELSE CASE WHEN A.SDW_COMP_ID = 'C0001296' THEN SK - C.PARTS_CREDIT * SK / A.BILLING_RATE ELSE SK END END, 0), 2) AS SK,

		ROUND(VALUE(CASE WHEN C.PARTS_CREDIT = 0 THEN YT ELSE CASE WHEN A.SDW_COMP_ID = 'C0001296' THEN YT - C.PARTS_CREDIT * YT / A.BILLING_RATE ELSE YT END END, 0), 2) AS YT    

		FROM SUB2 A LEFT JOIN PARTS_CREDIT C ON A.SDW_COMP_ID = C.SDW_COMP_ID 

		WHERE A.SDW_COMP_ID IN ('C0001296')

		)



		SELECT * FROM FINAL_RESULT ORDER BY SDW_COMP_ID

		

	"/>

      </subReport>

      

      <subReport includeHeader="None" includeTotals="N">

	<SQL text="



		WITH SDW_COMPONENTS(SDW_COMP_ID) AS (

		SELECT SDW_COMP_ID FROM LENOVO.SDW_COMPONENTS WHERE LENOVO_INT = 'Y'

		),



		TARGET_PERIOD(PERIOD_END_DTE) AS (

		SELECT MAX(PERIOD_END_DTE) FROM LENOVO.PERIOD_DATES WHERE LEN_DATA_REC = 'Y'

		),



		PARTS_CREDIT(KEY, PARTS_CREDIT) AS 

		( 

		SELECT 'PARTS', 

		VALUE(SUM(PART_CREDIT),0) AS PARTS_CREDIT 

		FROM LENOVO.PL_DETAIL_CR 

		WHERE PERIOD_END_DTE IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 

		AND STATUS = 'CREDIT' 

		AND WW_CDE = '61' 

		AND SDW_COMP_ID NOT IN (SELECT SDW_COMP_ID FROM SDW_COMPONENTS)

		AND COUNTRY_CDE = '649'

		AND CREDIT_CDE IN ('001', '002', '004')

		),



		PARTS_WAC(KEY, PARTS_WAC) AS 

		(

		SELECT 'PARTS', 

		VALUE(SUM(PART_COST), 0) AS PART_WAC

		FROM LENOVO.PL_DETAIL_CR 

		WHERE PERIOD_END_DTE IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 

		AND STATUS = 'CREDIT' 

		AND WW_CDE = '60'

		AND SDW_COMP_ID NOT IN (SELECT SDW_COMP_ID FROM SDW_COMPONENTS)

		AND COUNTRY_CDE = '649'

		AND CREDIT_CDE IN ('001', '002', '004')

		),



		PARTS_OTHER(KEY, PARTS_OTHER) AS 

		(

		SELECT 'PARTS', 

		VALUE(SUM(PART_COST), 0) AS PARTS_OTHER

		FROM LENOVO.PL_DETAIL_CR 

		WHERE PERIOD_END_DTE IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 

		AND STATUS = 'CREDIT' 

		AND WW_CDE NOT IN('61', '60')

		AND SDW_COMP_ID NOT IN (SELECT SDW_COMP_ID FROM SDW_COMPONENTS)

		AND COUNTRY_CDE = '649'

		AND CREDIT_CDE IN ('001', '002', '004', '003')

		),



		PARTS_DIST(KEY, PARTS_DIST) AS 

		(

		SELECT 'PARTS', 

		VALUE(SUM(BILLING_RATE * TRANSACTION_CNT), 0) AS PARTS_DIST

		FROM LENOVO.PL_DETAIL_CR 

		WHERE PERIOD_END_DTE IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 

		AND STATUS = 'CREDIT' 

		AND WW_CDE NOT IN('61', '60')

		AND SDW_COMP_ID NOT IN (SELECT SDW_COMP_ID FROM SDW_COMPONENTS)

		AND COUNTRY_CDE = '649'

		AND CREDIT_CDE IN ('001', '002', '004')

		),



		PARTS AS

		(

		SELECT VALUE(PARTS_WAC, 0) +  VALUE(PARTS_OTHER, 0)  +  VALUE(PARTS_DIST, 0) - VALUE(PARTS_CREDIT, 0) AS TOTAL_PARTS		

		FROM PARTS_WAC A LEFT JOIN PARTS_OTHER B ON A .KEY = B.KEY 

		LEFT JOIN PARTS_CREDIT C ON A.KEY = C.KEY

		LEFT JOIN PARTS_DIST D ON A.KEY = D.KEY

		),



		BF AS 

		(

		SELECT SUM(BILLING_RATE * TRANSACTION_CNT) AS TOTAL_BF

		FROM LENOVO.BF_DETAIL_CR A

		WHERE PERIOD_END_DTE IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 

		AND STATUS = 'CREDIT'

		AND COUNTRY_CDE = '649'

		AND CREDIT_CDE IN ('001', '002', '004')

		AND SDW_COMP_ID NOT IN (SELECT SDW_COMP_ID FROM SDW_COMPONENTS)

		),



		RCS AS 

		(

		SELECT SUM(BILLING_RATE * TRANSACTION_CNT) AS TOTAL_RCS

		FROM LENOVO.RCS_DETAIL_CR A

		WHERE PERIOD_END_DTE IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 

		AND STATUS = 'CREDIT'

		AND COUNTRY_CDE = '649'

		AND CREDIT_CDE IN ('001', '002', '004')

		AND SDW_COMP_ID NOT IN (SELECT SDW_COMP_ID FROM SDW_COMPONENTS)

		),



		DR AS 

		(

		SELECT SUM(BILLING_RATE * TRANSACTION_CNT) AS TOTAL_DR

		FROM LENOVO.DR_DETAIL_CR A

		WHERE PERIOD_END_DTE IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 

		AND STATUS = 'CREDIT'

		AND COUNTRY_CDE = '649'

		AND CREDIT_CDE IN ('001', '002', '004')

		AND SDW_COMP_ID NOT IN (SELECT SDW_COMP_ID FROM SDW_COMPONENTS)

		),



		TOTAL_ALL AS 

		(

		SELECT TOTAL_PARTS AS TOTALS FROM PARTS

		UNION 

		SELECT TOTAL_RCS   AS TOTALS FROM RCS

		UNION

		SELECT TOTAL_BF   AS TOTALS FROM BF

		UNION

		SELECT TOTAL_DR   AS TOTALS FROM DR

		)



		SELECT '', '', 'NON LENOVO EMPLOYEE NET', VALUE(ROUND(SUM(TOTALS), 2),0) FROM TOTAL_ALL      	

	

	"/>

      </subReport>



      <subReport includeHeader="None" includeTotals="N">

      	<SQL text=" 

      	

      	VALUES ('', 'LENOVO EMPLOYEE BILLING (TAXABLE)')

      	

      	"/>

      </subReport>





      <subReport includeHeader="Db2Header" includeTotals="Y">

      	<SQL text="



		WITH SDW_COMPONENTS(SDW_COMP_ID) AS (

		SELECT SDW_COMP_ID FROM LENOVO.SDW_COMPONENTS WHERE LENOVO_INT = 'N'

		),



		WW_CODE_REF(WW_CDE, US_BILL_GRP) AS (

		SELECT DISTINCT WW_CDE, US_BILL_GRP FROM LENOVO.WW_CODE_REF

		),



		TARGET_PERIOD(PERIOD_END_DTE) AS (

		SELECT MAX(PERIOD_END_DTE) FROM LENOVO.PERIOD_DATES WHERE LEN_DATA_REC = 'Y'

		),



		SUB1 (WW_CDE, BILLING_RATE, TOTAL, AB, BC, MB, NB, NL, NT, NS, ON, PE, QC, SK, YT, OTHER) AS (

		SELECT WW_CDE, 

		SUM(BILLING_RATE * TRANSACTION_CNT) AS BILLING_RATE,

		VALUE(CAST(SUM(TRANSACTION_CNT) AS INTEGER), 0) AS TOTAL, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'ALBERTA' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS AB, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'BRITISH COLUMBIA' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS BC, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'MANITOBA' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS MB, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'NEW BRUNSWICK' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS NB, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'NEWFOUNDLAND' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS NL, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME IN ('N.W. TERRITORIES', 'NORTH WEST TERRITORIES', 'NORTHWEST TERRITORIES')  THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS NT, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'NOVA SCOTIA' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS NS,

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'ONTARIO' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS ON, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'PRINCE EDWARD ISLAND' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS PE, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'QUEBEC' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS QC, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME IN ('SASKATCHEWAN', 'SASKETCHEWAN') THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS SK, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'YUKON' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS YT,

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME NOT IN ('ALBERTA','BRITISH COLUMBIA','MANITOBA','NEW BRUNSWICK','NEWFOUNDLAND','N.W. TERRITORIES', 'NORTH WEST TERRITORIES', 'NORTHWEST TERRITORIES','NOVA SCOTIA','ONTARIO','PRINCE EDWARD ISLAND','QUEBEC','SASKATCHEWAN','SASKETCHEWAN','YUKON') THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS OTHER

		FROM LENOVO.BF_DETAIL_CR A

		WHERE PERIOD_END_DTE IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 

		AND STATUS = 'CREDIT'

		AND COUNTRY_CDE = '649'

		AND CREDIT_CDE IN ('001', '002', '004')

		AND SDW_COMP_ID NOT IN (SELECT SDW_COMP_ID FROM SDW_COMPONENTS)

		GROUP BY WW_CDE



		UNION ALL



		SELECT WW_CDE, 

		SUM(BILLING_RATE * TRANSACTION_CNT) AS BILLING_RATE,

		VALUE(CAST(SUM(TRANSACTION_CNT) AS INTEGER), 0) AS TOTAL, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'ALBERTA' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS AB, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'BRITISH COLUMBIA' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS BC, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'MANITOBA' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS MB, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'NEW BRUNSWICK' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS NB, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'NEWFOUNDLAND' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS NL, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME IN ('N.W. TERRITORIES', 'NORTH WEST TERRITORIES', 'NORTHWEST TERRITORIES')  THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS NT, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'NOVA SCOTIA' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS NS,

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'ONTARIO' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS ON, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'PRINCE EDWARD ISLAND' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS PE, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'QUEBEC' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS QC, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME IN ('SASKATCHEWAN', 'SASKETCHEWAN') THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS SK, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'YUKON' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS YT,

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME NOT IN ('ALBERTA','BRITISH COLUMBIA','MANITOBA','NEW BRUNSWICK','NEWFOUNDLAND','N.W. TERRITORIES', 'NORTH WEST TERRITORIES', 'NORTHWEST TERRITORIES','NOVA SCOTIA','ONTARIO','PRINCE EDWARD ISLAND','QUEBEC','SASKATCHEWAN','SASKETCHEWAN','YUKON') THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS OTHER

		FROM LENOVO.DR_DETAIL_CR A

		WHERE PERIOD_END_DTE IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 

		AND STATUS = 'CREDIT'

		AND COUNTRY_CDE = '649'

		AND CREDIT_CDE IN ('001', '002', '004')

		AND SDW_COMP_ID NOT IN (SELECT SDW_COMP_ID FROM SDW_COMPONENTS)

		GROUP BY WW_CDE



		UNION ALL



		SELECT WW_CDE, 

		SUM(BILLING_RATE * TRANSACTION_CNT) AS BILLING_RATE,

		VALUE(CAST(SUM(TRANSACTION_CNT) AS INTEGER), 0) AS TOTAL, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'ALBERTA' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS AB, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'BRITISH COLUMBIA' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS BC, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'MANITOBA' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS MB, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'NEW BRUNSWICK' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS NB, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'NEWFOUNDLAND' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS NL, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME IN ('N.W. TERRITORIES', 'NORTH WEST TERRITORIES', 'NORTHWEST TERRITORIES')  THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS NT, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'NOVA SCOTIA' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS NS,

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'ONTARIO' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS ON, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'PRINCE EDWARD ISLAND' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS PE, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'QUEBEC' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS QC, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME IN ('SASKATCHEWAN', 'SASKETCHEWAN') THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS SK, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'YUKON' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS YT,

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME NOT IN ('ALBERTA','BRITISH COLUMBIA','MANITOBA','NEW BRUNSWICK','NEWFOUNDLAND','N.W. TERRITORIES', 'NORTH WEST TERRITORIES', 'NORTHWEST TERRITORIES','NOVA SCOTIA','ONTARIO','PRINCE EDWARD ISLAND','QUEBEC','SASKATCHEWAN','SASKETCHEWAN','YUKON') THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS OTHER

		FROM LENOVO.RCS_DETAIL_CR A

		WHERE PERIOD_END_DTE IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 

		AND STATUS = 'CREDIT'

		AND COUNTRY_CDE = '649'

		AND CREDIT_CDE IN ('001', '002', '004')

		AND SDW_COMP_ID NOT IN (SELECT SDW_COMP_ID FROM SDW_COMPONENTS)

		GROUP BY WW_CDE

		)



		SELECT 

		B.SDW_COMP_ID AS SDW_COMP_ID,

		C.US_BILL_GRP AS US_GROUP, 

		B.CDN_SDW_COMP_DESC AS BILL_DESCRIPTION, 

		SUM(A.BILLING_RATE) AS COMP_TOTAL, 

		SUM(A.TOTAL) AS TOTAL_TRX, 

		SUM(A.AB) AS AB, 

		SUM(A.BC) AS BC, 

		SUM(A.MB) AS MB, 

		SUM(A.NB) AS NB, 

		SUM(A.NL) AS NL, 

		SUM(A.NT)AS NT, 

		SUM(A.NS) AS NS, 

		SUM(A.ON) + SUM(OTHER) AS ON, 

		SUM(A.PE) AS PE, 

		SUM(A.QC) AS QC, 

		SUM(A.SK) AS SK, 

		SUM(A.YT) AS YT 

		FROM SUB1 A LEFT JOIN LENOVO.SDW_COMPONENTS B ON A.WW_CDE = B.WW_CDE AND 'Y' = B.LENOVO_INT 

		LEFT JOIN WW_CODE_REF C ON A.WW_CDE = C.WW_CDE

		GROUP BY B.SDW_COMP_ID, C.US_BILL_GRP, B.CDN_SDW_COMP_DESC ORDER BY B.SDW_COMP_ID

	"/>

      </subReport>

      

      <subReport includeHeader="None" includeTotals="Y">

	<SQL text="



		WITH SDW_COMPONENTS(SDW_COMP_ID) AS (

		SELECT SDW_COMP_ID FROM LENOVO.SDW_COMPONENTS WHERE LENOVO_INT = 'N'

		),



		WW_CODE_REF(WW_CDE, US_BILL_GRP, RATE_LOOKUP) AS (

		SELECT DISTINCT WW_CDE, US_BILL_GRP, RATE_LOOKUP FROM LENOVO.WW_CODE_REF

		),



		TARGET_PERIOD(PERIOD_END_DTE) AS (

		SELECT MAX(PERIOD_END_DTE) FROM LENOVO.PERIOD_DATES WHERE LEN_DATA_REC = 'Y'

		),



		SUB1 (WW_CDE, BILLING_RATE, TOTAL, AB, BC, MB, NB, NL, NT, NS, ON, PE, QC, SK, YT, OTHER) AS (

		SELECT WW_CDE, 

		SUM(BILLING_RATE * TRANSACTION_CNT) AS BILLING_RATE,

		VALUE(CAST(SUM(TRANSACTION_CNT) AS INTEGER), 0) AS TOTAL, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'ALBERTA' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS AB, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'BRITISH COLUMBIA' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS BC, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'MANITOBA' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS MB, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'NEW BRUNSWICK' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS NB, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'NEWFOUNDLAND' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS NL, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME IN ('N.W. TERRITORIES', 'NORTH WEST TERRITORIES', 'NORTHWEST TERRITORIES')  THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS NT, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'NOVA SCOTIA' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS NS,

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'ONTARIO' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS ON, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'PRINCE EDWARD ISLAND' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS PE, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'QUEBEC' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS QC, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME IN ('SASKATCHEWAN', 'SASKETCHEWAN') THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS SK, 

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME = 'YUKON' THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS YT,

		VALUE(CAST(SUM(CASE WHEN PROVINCE_NAME NOT IN ('ALBERTA','BRITISH COLUMBIA','MANITOBA','NEW BRUNSWICK','NEWFOUNDLAND','N.W. TERRITORIES', 'NORTH WEST TERRITORIES', 'NORTHWEST TERRITORIES','NOVA SCOTIA','ONTARIO','PRINCE EDWARD ISLAND','QUEBEC','SASKATCHEWAN','SASKETCHEWAN','YUKON') THEN (TRANSACTION_CNT * BILLING_RATE) END) AS DOUBLE), 0) AS OTHER

		FROM LENOVO.PL_DETAIL_CR A

		WHERE PERIOD_END_DTE IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 

		AND STATUS = 'CREDIT'

		AND COUNTRY_CDE = '649'

		AND CREDIT_CDE IN ('001', '002', '004')

		AND SDW_COMP_ID NOT IN (SELECT SDW_COMP_ID FROM SDW_COMPONENTS)

		GROUP BY WW_CDE

		)



		SELECT B.SDW_COMP_ID, C.US_BILL_GRP, B.CDN_SDW_COMP_DESC, SUM(A.BILLING_RATE), SUM(A.TOTAL), SUM(A.AB), SUM(A.BC), SUM(A.MB), SUM(A.NB), SUM(A.NL), SUM(A.NT), SUM(A.NS), SUM(A.ON) + SUM(A.OTHER), SUM(A.PE), SUM(A.QC), SUM(A.SK), SUM(A.YT) 

		FROM SUB1 A LEFT JOIN LENOVO.SDW_COMPONENTS B ON A.WW_CDE = B.WW_CDE AND 'Y' = B.LENOVO_INT

		LEFT JOIN WW_CODE_REF C ON A.WW_CDE = C.WW_CDE

		WHERE RATE_LOOKUP = 'Y'

		GROUP BY B.SDW_COMP_ID, C.US_BILL_GRP, B.CDN_SDW_COMP_DESC ORDER BY B.SDW_COMP_ID



	"/>

      </subReport>



      <subReport includeHeader="None" includeTotals="Y">

	<SQL text="



		WITH SDW_COMPONENTS(SDW_COMP_ID) AS (

		SELECT SDW_COMP_ID FROM LENOVO.SDW_COMPONENTS WHERE LENOVO_INT = 'N'

		),



		WW_CODE_REF(WW_CDE, US_BILL_GRP, RATE_LOOKUP) AS (

		SELECT DISTINCT WW_CDE, US_BILL_GRP, RATE_LOOKUP FROM LENOVO.WW_CODE_REF

		),



		TARGET_PERIOD(PERIOD_END_DTE) AS (

		SELECT MAX(PERIOD_END_DTE) FROM LENOVO.PERIOD_DATES WHERE LEN_DATA_REC = 'Y'

		),



		PARTS_CREDIT(SDW_COMP_ID, PARTS_CREDIT) AS (

		SELECT 'C0001371' AS SDW_COMP_ID, CAST(VALUE(SUM(PART_CREDIT),0)AS DECIMAL(15,7)) AS PARTS_CREDIT 

		FROM LENOVO.PL_DETAIL_CR 

		WHERE PERIOD_END_DTE IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 

		AND STATUS = 'CREDIT' AND WW_CDE = '61' AND CREDIT_CDE IN ('001', '002', '004') AND SDW_COMP_ID NOT IN (SELECT SDW_COMP_ID FROM SDW_COMPONENTS)

		AND COUNTRY_CDE = '649'

		),



		SUB1 (WW_CDE, BILLING_RATE, TOTAL, AB, BC, MB, NB, NL, NT, NS, ON, PE, QC, SK, YT,OTHER) AS (

		SELECT WW_CDE, 

		SUM(PART_COST) AS BILLING_RATE,

		0 AS  TOTAL,

		VALUE(SUM(CASE WHEN PROVINCE_NAME = 'ALBERTA' THEN PART_COST END), 0) AS AB, 

		VALUE(SUM(CASE WHEN PROVINCE_NAME = 'BRITISH COLUMBIA' THEN PART_COST END), 0) AS BC, 

		VALUE(SUM(CASE WHEN PROVINCE_NAME = 'MANITOBA' THEN PART_COST END), 0) AS MB, 

		VALUE(SUM(CASE WHEN PROVINCE_NAME = 'NEW BRUNSWICK' THEN PART_COST END), 0) AS NB, 

		VALUE(SUM(CASE WHEN PROVINCE_NAME = 'NEWFOUNDLAND' THEN PART_COST END), 0) AS NL, 

		VALUE(SUM(CASE WHEN PROVINCE_NAME IN ('N.W. TERRITORIES', 'NORTH WEST TERRITORIES', 'NORTHWEST TERRITORIES')  THEN PART_COST END), 0) AS NT, 

		VALUE(SUM(CASE WHEN PROVINCE_NAME = 'NOVA SCOTIA' THEN PART_COST END), 0) AS NS,

		VALUE(SUM(CASE WHEN PROVINCE_NAME = 'ONTARIO' THEN PART_COST END), 0) AS ON, 

		VALUE(SUM(CASE WHEN PROVINCE_NAME = 'PRINCE EDWARD ISLAND' THEN PART_COST END), 0) AS PE, 

		VALUE(SUM(CASE WHEN PROVINCE_NAME = 'QUEBEC' THEN PART_COST END), 0) AS QC, 

		VALUE(SUM(CASE WHEN PROVINCE_NAME IN ('SASKATCHEWAN', 'SASKETCHEWAN') THEN PART_COST END), 0) AS SK, 

		VALUE(SUM(CASE WHEN PROVINCE_NAME = 'YUKON' THEN PART_COST END), 0) AS YT,

		VALUE(SUM(CASE WHEN PROVINCE_NAME NOT IN ('ALBERTA','BRITISH COLUMBIA','MANITOBA','NEW BRUNSWICK','NEWFOUNDLAND','N.W. TERRITORIES', 'NORTH WEST TERRITORIES', 'NORTHWEST TERRITORIES','NOVA SCOTIA','ONTARIO','PRINCE EDWARD ISLAND','QUEBEC','SASKATCHEWAN', 'SASKETCHEWAN','YUKON') THEN PART_COST END), 0) AS OTHER

		FROM LENOVO.PL_DETAIL_CR A

		WHERE PERIOD_END_DTE IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 

		AND STATUS = 'CREDIT'

		AND COUNTRY_CDE = '649'

		AND CREDIT_CDE IN ('001', '002', '004', '003')

		AND SDW_COMP_ID NOT IN (SELECT SDW_COMP_ID FROM SDW_COMPONENTS)

		GROUP BY WW_CDE

		),



		SUB2 (SDW_COMP_ID, US_BILL_GRP, CDN_SDW_COMP_DESC, BILLING_RATE, TOTAL, AB, BC, MB, NB, NL, NT, NS, ON, PE, QC, SK, YT)  AS (

		SELECT B.SDW_COMP_ID,

		C.US_BILL_GRP,  

		B.CDN_SDW_COMP_DESC,

		CAST (SUM(A.BILLING_RATE) AS DECIMAL(15,7)),

		CAST (SUM(A.TOTAL) AS DECIMAL(15,7)),

		CAST (SUM(A.AB) AS DECIMAL(15,7)),

		CAST (SUM(A.BC) AS DECIMAL(15,7)),

		CAST (SUM(A.MB) AS DECIMAL(15,7)),

		CAST (SUM(A.NB) AS DECIMAL(15,7)),

		CAST (SUM(A.NL) AS DECIMAL(15,7)),

		CAST (SUM(A.NT) AS DECIMAL(15,7)),

		CAST (SUM(A.NS) AS DECIMAL(15,7)),

		CAST (VALUE(SUM(A.ON), 0) + VALUE(SUM(A.OTHER), 0) AS DECIMAL(15,7)),

		CAST (SUM(A.PE) AS DECIMAL(15,7)),

		CAST (SUM(A.QC) AS DECIMAL(15,7)),

		CAST (SUM(A.SK) AS DECIMAL(15,7)),

		CAST (SUM(A.YT) AS DECIMAL(15,7))

		FROM SUB1 A LEFT JOIN LENOVO.SDW_COMPONENTS B ON A.WW_CDE = B.WW_CDE AND 'Y' = B.LENOVO_INT

		LEFT JOIN WW_CODE_REF C ON A.WW_CDE = C.WW_CDE

		GROUP BY B.SDW_COMP_ID, C.US_BILL_GRP, B.CDN_SDW_COMP_DESC

		),





		FINAL_RESULT (SDW_COMP_ID, US_BILL_GRP, CDN_SDW_COMP_DESC, BILLING_RATE, TOTAL, AB, BC, MB, NB, NL, NT, NS, ON, PE, QC, SK, YT)  AS (

		SELECT 

		B.SDW_COMP_ID, 

		C.US_BILL_GRP,

		B.CDN_SDW_COMP_DESC,

		ROUND(SUM(A.BILLING_RATE), 2),

		ROUND(SUM(A.TOTAL), 2),

		ROUND(SUM(A.AB), 2), 

		ROUND(SUM(A.BC), 2),

		ROUND(SUM(A.MB), 2),

		ROUND(SUM(A.NB), 2),

		ROUND(SUM(A.NL), 2),

		ROUND(SUM(A.NT), 2),

		ROUND(SUM(A.NS), 2),

		ROUND(SUM(A.ON) + SUM(A.OTHER), 2) AS ON,

		ROUND(SUM(A.PE), 2),

		ROUND(SUM(A.QC), 2),

		ROUND(SUM(A.SK), 2),

		ROUND(SUM(A.YT), 2)

		FROM SUB1 A LEFT JOIN LENOVO.SDW_COMPONENTS B ON A.WW_CDE = B.WW_CDE AND 'Y' = B.LENOVO_INT

		LEFT JOIN WW_CODE_REF C ON A.WW_CDE = C.WW_CDE

		WHERE SDW_COMP_ID NOT IN ('C0001371', 'C0001372')

		AND RATE_LOOKUP = 'N'

		GROUP BY B.SDW_COMP_ID, C.US_BILL_GRP, B.CDN_SDW_COMP_DESC



		UNION ALL



		SELECT 

		A.SDW_COMP_ID,

		A.US_BILL_GRP, 

		A.CDN_SDW_COMP_DESC,

		ROUND(CASE WHEN A.SDW_COMP_ID = 'C0001371' THEN A.BILLING_RATE - C.PARTS_CREDIT ELSE A.BILLING_RATE END, 2) AS BILLING_RATE,

		ROUND(A.TOTAL, 2),

		ROUND(VALUE(CASE WHEN C.PARTS_CREDIT = 0 THEN AB ELSE CASE WHEN A.SDW_COMP_ID = 'C0001371' THEN AB - C.PARTS_CREDIT * AB / A.BILLING_RATE ELSE AB END END, 0), 2) AS AB,

		ROUND(VALUE(CASE WHEN C.PARTS_CREDIT = 0 THEN BC ELSE CASE WHEN A.SDW_COMP_ID = 'C0001371' THEN BC - C.PARTS_CREDIT * BC / A.BILLING_RATE ELSE BC END END, 0), 2) AS BC,

		ROUND(VALUE(CASE WHEN C.PARTS_CREDIT = 0 THEN MB ELSE CASE WHEN A.SDW_COMP_ID = 'C0001371' THEN MB - C.PARTS_CREDIT * MB / A.BILLING_RATE ELSE MB END END, 0), 2) AS MB,

		ROUND(VALUE(CASE WHEN C.PARTS_CREDIT = 0 THEN NB ELSE CASE WHEN A.SDW_COMP_ID = 'C0001371' THEN NB - C.PARTS_CREDIT * NB / A.BILLING_RATE ELSE NB END END, 0), 2) AS NB,

		ROUND(VALUE(CASE WHEN C.PARTS_CREDIT = 0 THEN NL ELSE CASE WHEN A.SDW_COMP_ID = 'C0001371' THEN NL - C.PARTS_CREDIT * NL / A.BILLING_RATE ELSE NL END END, 0), 2) AS NL,

		ROUND(VALUE(CASE WHEN C.PARTS_CREDIT = 0 THEN NT ELSE CASE WHEN A.SDW_COMP_ID = 'C0001371' THEN NT - C.PARTS_CREDIT * NT / A.BILLING_RATE ELSE NT END END, 0), 2) AS NT,

		ROUND(VALUE(CASE WHEN C.PARTS_CREDIT = 0 THEN NS ELSE CASE WHEN A.SDW_COMP_ID = 'C0001371' THEN NS - C.PARTS_CREDIT * NS / A.BILLING_RATE ELSE NS END END, 0), 2) AS NS,

		ROUND(VALUE(CASE WHEN C.PARTS_CREDIT = 0 THEN ON ELSE CASE WHEN A.SDW_COMP_ID = 'C0001371' THEN ON - C.PARTS_CREDIT * ON / A.BILLING_RATE ELSE ON END END, 0), 2) AS ON,

		ROUND(VALUE(CASE WHEN C.PARTS_CREDIT = 0 THEN PE ELSE CASE WHEN A.SDW_COMP_ID = 'C0001371' THEN PE - C.PARTS_CREDIT * PE / A.BILLING_RATE ELSE PE END END, 0), 2) AS PE,

		ROUND(VALUE(CASE WHEN C.PARTS_CREDIT = 0 THEN QC ELSE CASE WHEN A.SDW_COMP_ID = 'C0001371' THEN QC - C.PARTS_CREDIT * QC / A.BILLING_RATE ELSE QC END END, 0), 2) AS QC,

		ROUND(VALUE(CASE WHEN C.PARTS_CREDIT = 0 THEN SK ELSE CASE WHEN A.SDW_COMP_ID = 'C0001371' THEN SK - C.PARTS_CREDIT * SK / A.BILLING_RATE ELSE SK END END, 0), 2) AS SK,

		ROUND(VALUE(CASE WHEN C.PARTS_CREDIT = 0 THEN YT ELSE CASE WHEN A.SDW_COMP_ID = 'C0001371' THEN YT - C.PARTS_CREDIT * YT / A.BILLING_RATE ELSE YT END END, 0), 2) AS YT    

		FROM SUB2 A LEFT JOIN PARTS_CREDIT C ON A.SDW_COMP_ID = C.SDW_COMP_ID 

		WHERE A.SDW_COMP_ID IN ('C0001371')

		)



		SELECT * FROM FINAL_RESULT ORDER BY SDW_COMP_ID



	"/>

      </subReport>





      <subReport includeHeader="None" includeTotals="N">

	<SQL text="



		WITH SDW_COMPONENTS(SDW_COMP_ID) AS (

		SELECT SDW_COMP_ID FROM LENOVO.SDW_COMPONENTS WHERE LENOVO_INT = 'N'

		),



		TARGET_PERIOD(PERIOD_END_DTE) AS (

		SELECT MAX(PERIOD_END_DTE) FROM LENOVO.PERIOD_DATES WHERE LEN_DATA_REC = 'Y'

		),



		PARTS_CREDIT(KEY, PARTS_CREDIT) AS 

		( 

		SELECT 'PARTS', 

		VALUE(SUM(PART_CREDIT),0) AS PARTS_CREDIT 

		FROM LENOVO.PL_DETAIL_CR 

		WHERE PERIOD_END_DTE IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 

		AND STATUS = 'CREDIT' 

		AND WW_CDE = '61' 

		AND SDW_COMP_ID NOT IN (SELECT SDW_COMP_ID FROM SDW_COMPONENTS)

		AND COUNTRY_CDE = '649'

		AND CREDIT_CDE IN ('001', '002', '004')

		),



		PARTS_WAC(KEY, PARTS_WAC) AS 

		(

		SELECT 'PARTS', 

		VALUE(SUM(PART_COST), 0) AS PART_WAC

		FROM LENOVO.PL_DETAIL_CR 

		WHERE PERIOD_END_DTE IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 

		AND STATUS = 'CREDIT' 

		AND WW_CDE = '60'

		AND SDW_COMP_ID NOT IN (SELECT SDW_COMP_ID FROM SDW_COMPONENTS)

		AND COUNTRY_CDE = '649'

		AND CREDIT_CDE IN ('001', '002', '004')

		),

		

		PARTS_OTHER(KEY, PARTS_OTHER) AS 

		(

		SELECT 'PARTS', 

		VALUE(SUM(PART_COST), 0) AS PARTS_OTHER

		FROM LENOVO.PL_DETAIL_CR 

		WHERE PERIOD_END_DTE IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 

		AND STATUS = 'CREDIT' 

		AND WW_CDE NOT IN('61', '60')

		AND SDW_COMP_ID NOT IN (SELECT SDW_COMP_ID FROM SDW_COMPONENTS)

		AND COUNTRY_CDE = '649'

		AND CREDIT_CDE IN ('001', '002', '004', '003')

		),



		PARTS_DIST(KEY, PARTS_DIST) AS 

		(

		SELECT 'PARTS', 

		VALUE(SUM(BILLING_RATE * TRANSACTION_CNT), 0) AS PARTS_DIST

		FROM LENOVO.PL_DETAIL_CR 

		WHERE PERIOD_END_DTE IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 

		AND STATUS = 'CREDIT' 

		AND WW_CDE NOT IN('61', '60')

		AND SDW_COMP_ID NOT IN (SELECT SDW_COMP_ID FROM SDW_COMPONENTS)

		AND COUNTRY_CDE = '649'

		AND CREDIT_CDE IN ('001', '002', '004')

		),





		PARTS AS

		(

		SELECT VALUE(PARTS_WAC, 0) +  VALUE(PARTS_OTHER, 0)  +  VALUE(PARTS_DIST, 0) - VALUE(PARTS_CREDIT, 0) AS TOTAL_PARTS		

		FROM PARTS_WAC A LEFT JOIN PARTS_OTHER B ON A .KEY = B.KEY 

		LEFT JOIN PARTS_CREDIT C ON A.KEY = C.KEY

		LEFT JOIN PARTS_DIST D ON A.KEY = D.KEY

		),



		BF AS 

		(

		SELECT SUM(BILLING_RATE * TRANSACTION_CNT) AS TOTAL_BF

		FROM LENOVO.BF_DETAIL_CR A

		WHERE PERIOD_END_DTE IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 

		AND STATUS = 'CREDIT'

		AND COUNTRY_CDE = '649'

		AND CREDIT_CDE IN ('001', '002', '004')

		AND SDW_COMP_ID NOT IN (SELECT SDW_COMP_ID FROM SDW_COMPONENTS)

		),



		RCS AS 

		(

		SELECT SUM(BILLING_RATE * TRANSACTION_CNT) AS TOTAL_RCS

		FROM LENOVO.RCS_DETAIL_CR A

		WHERE PERIOD_END_DTE IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 

		AND STATUS = 'CREDIT'

		AND COUNTRY_CDE = '649'

		AND CREDIT_CDE IN ('001', '002', '004')

		AND SDW_COMP_ID NOT IN (SELECT SDW_COMP_ID FROM SDW_COMPONENTS)

		),



		DR AS 

		(

		SELECT SUM(BILLING_RATE * TRANSACTION_CNT) AS TOTAL_DR

		FROM LENOVO.DR_DETAIL_CR A

		WHERE PERIOD_END_DTE IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 

		AND STATUS = 'CREDIT'

		AND COUNTRY_CDE = '649'

		AND CREDIT_CDE IN ('001', '002', '004')

		AND SDW_COMP_ID NOT IN (SELECT SDW_COMP_ID FROM SDW_COMPONENTS)

		),



		TOTAL_ALL AS 

		(

		SELECT TOTAL_PARTS  AS TOTALS FROM PARTS 

		UNION 

		SELECT TOTAL_RCS   AS TOTALS FROM RCS

		UNION

		SELECT TOTAL_BF   AS TOTALS FROM BF

		UNION

		SELECT TOTAL_DR   AS TOTALS FROM DR

		)



		SELECT '', '', 'LENOVO EMPLOYEE NET', VALUE(ROUND(SUM(TOTALS), 2),0) FROM TOTAL_ALL

	"/>

      </subReport>





     <subReport includeHeader="None" includeTotals="N">

	<SQL text="

	

		WITH TARGET_PERIOD(PERIOD_END_DTE) AS (

		SELECT MAX(PERIOD_END_DTE) FROM LENOVO.PERIOD_DATES WHERE LEN_DATA_REC = 'Y'

		),



		PARTS_CREDIT(KEY, PARTS_CREDIT) AS 

		( 

		SELECT 'PARTS', 

		VALUE(SUM(PART_CREDIT),0) AS PARTS_CREDIT 

		FROM LENOVO.PL_DETAIL_CR 

		WHERE PERIOD_END_DTE IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 

		AND STATUS = 'CREDIT' 

		AND WW_CDE = '61' 

		AND COUNTRY_CDE = '649'

		AND CREDIT_CDE IN ('001', '002', '004')

		),



		PARTS_WAC(KEY, PARTS_WAC) AS 

		(

		SELECT 'PARTS', 

		VALUE(SUM(PART_COST), 0) AS PART_WAC

		FROM LENOVO.PL_DETAIL_CR 

		WHERE PERIOD_END_DTE IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 

		AND STATUS = 'CREDIT' 

		AND WW_CDE = '60'

		AND COUNTRY_CDE = '649'

		AND CREDIT_CDE IN ('001', '002', '004')

		),



		PARTS_OTHER(KEY, PARTS_OTHER) AS 

		(

		SELECT 'PARTS', 

		VALUE(SUM(PART_COST), 0) AS PARTS_OTHER

		FROM LENOVO.PL_DETAIL_CR 

		WHERE PERIOD_END_DTE IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 

		AND STATUS = 'CREDIT' 

		AND WW_CDE NOT IN('61', '60')

		AND COUNTRY_CDE = '649'

		AND CREDIT_CDE IN ('001', '002', '004', '003')

		),



		PARTS_DIST(KEY, PARTS_DIST) AS 

		(

		SELECT 'PARTS', 

		VALUE(SUM(BILLING_RATE * TRANSACTION_CNT), 0) AS PARTS_DIST

		FROM LENOVO.PL_DETAIL_CR 

		WHERE PERIOD_END_DTE IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 

		AND STATUS = 'CREDIT' 

		AND WW_CDE NOT IN('61', '60')

		AND COUNTRY_CDE = '649'

		AND CREDIT_CDE IN ('001', '002', '004')

		),



		PARTS AS

		(

		SELECT VALUE(PARTS_WAC, 0) +  VALUE(PARTS_OTHER, 0)  +  VALUE(PARTS_DIST, 0) - VALUE(PARTS_CREDIT, 0) AS TOTAL_PARTS				

		FROM PARTS_WAC A LEFT JOIN PARTS_OTHER B ON A .KEY = B.KEY 

		LEFT JOIN PARTS_CREDIT C ON A.KEY = C.KEY

		LEFT JOIN PARTS_DIST D ON A.KEY = D.KEY

		),



		BF AS 

		(

		SELECT SUM(BILLING_RATE * TRANSACTION_CNT) AS TOTAL_BF

		FROM LENOVO.BF_DETAIL_CR A

		WHERE PERIOD_END_DTE IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 

		AND STATUS = 'CREDIT'

		AND COUNTRY_CDE = '649'

		AND CREDIT_CDE IN ('001', '002', '004')

		),



		RCS AS 

		(

		SELECT SUM(BILLING_RATE * TRANSACTION_CNT) AS TOTAL_RCS

		FROM LENOVO.RCS_DETAIL_CR A

		WHERE PERIOD_END_DTE IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 

		AND STATUS = 'CREDIT'

		AND COUNTRY_CDE = '649'

		AND CREDIT_CDE IN ('001', '002', '004')

		),



		DR AS 

		(

		SELECT SUM(BILLING_RATE * TRANSACTION_CNT) AS TOTAL_DR

		FROM LENOVO.DR_DETAIL_CR A

		WHERE PERIOD_END_DTE IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 

		AND STATUS = 'CREDIT'

		AND COUNTRY_CDE = '649'

		AND CREDIT_CDE IN ('001', '002', '004')

		),



		TOTAL_ALL AS 

		(

		SELECT TOTAL_PARTS  AS TOTALS FROM PARTS 

		UNION 

		SELECT TOTAL_RCS   AS TOTALS FROM RCS

		UNION

		SELECT TOTAL_BF   AS TOTALS FROM BF

		UNION

		SELECT TOTAL_DR   AS TOTALS FROM DR

		)



		SELECT '', '', 'INVOICE TOTAL', VALUE(ROUND(SUM(TOTALS), 2),0) FROM TOTAL_ALL

	"/>

      </subReport>



      

  </multiReport>    



</reports>

