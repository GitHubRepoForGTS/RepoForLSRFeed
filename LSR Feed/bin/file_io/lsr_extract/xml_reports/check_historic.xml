<?xml version="1.0" encoding="UTF-8"?>

<!-- Modification History                            	 		-->
<!-- 2009-08-17 | VM | First Cut  -->


<!DOCTYPE reports SYSTEM "./../../dtd/LSRExtract.dtd">

<reports>

    <report includeHeader="None">
    <fileName text="check_historic.csv" />
    <SQL text="
		WITH CURRENT_WW_RATE(WW_CDE, BILLING_RATE) AS (
		  SELECT WW_CDE, BILLING_RATE FROM LENOVO.WW_CODE_REF WHERE (WW_CDE, END_DATE) IN ( 
		    SELECT WW_CDE, MAX(END_DATE)  FROM LENOVO.WW_CODE_REF WHERE RATE_LOOKUP = 'Y' AND (WW_CDE, END_DATE) NOT IN (
		      SELECT WW_CDE, MAX(END_DATE)  FROM LENOVO.WW_CODE_REF WHERE RATE_LOOKUP = 'Y' GROUP BY WW_CDE
		    ) GROUP BY WW_CDE
		  )
		),

    		TARGET_PERIOD(PERIOD_END_DTE) AS (
    		SELECT MAX(PERIOD_END_DTE) FROM LENOVO.PERIOD_DATES WHERE LEN_DATA_REC = 'Y'
    		),
    
		SUB1 (WW_CDE, BILLING_RATE) AS (
    		SELECT DISTINCT WW_CDE, BILLING_RATE FROM LENOVO.PL_ALL_BYWW_V  
		WHERE EFFECTIVE_PERIOD IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 
		AND DETAIL_STATUS = 'APPROVED' 
		AND COUNTRY_CDE = '649' 
		AND (WW_CDE, BILLING_RATE) IN (SELECT WW_CDE, BILLING_RATE FROM CURRENT_WW_RATE) UNION ALL

		SELECT DISTINCT WW_CDE, BILLING_RATE FROM LENOVO.RCS_ALL_BYWW_V  
		WHERE EFFECTIVE_PERIOD IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 
		AND DETAIL_STATUS = 'APPROVED' 
		AND COUNTRY_CDE = '649' 
		AND (WW_CDE, BILLING_RATE) IN (SELECT WW_CDE, BILLING_RATE FROM CURRENT_WW_RATE) UNION ALL

		SELECT DISTINCT WW_CDE, BILLING_RATE FROM LENOVO.BF_ALL_BYWW_V  
		WHERE EFFECTIVE_PERIOD IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 
		AND DETAIL_STATUS = 'APPROVED' 
		AND COUNTRY_CDE = '649' 
		AND (WW_CDE, BILLING_RATE) IN (SELECT WW_CDE, BILLING_RATE FROM CURRENT_WW_RATE) UNION ALL

		SELECT DISTINCT WW_CDE, BILLING_RATE FROM LENOVO.DR_ALL_BYWW_V  
		WHERE EFFECTIVE_PERIOD IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 
		AND DETAIL_STATUS = 'APPROVED' 
		AND COUNTRY_CDE = '649' 
		AND (WW_CDE, BILLING_RATE) IN (SELECT WW_CDE, BILLING_RATE FROM CURRENT_WW_RATE) UNION ALL

		SELECT DISTINCT WW_CDE, BILLING_RATE FROM LENOVO.INS_ALL_BYWW_V  
		WHERE EFFECTIVE_PERIOD IN (SELECT PERIOD_END_DTE FROM TARGET_PERIOD) 
		AND DETAIL_STATUS = 'APPROVED' 
		AND COUNTRY_CDE = '649' 
		AND (WW_CDE, BILLING_RATE) IN (SELECT WW_CDE, BILLING_RATE FROM CURRENT_WW_RATE)
		)
    
		SELECT COUNT(*) FROM SUB1

	" />
  </report>

</reports>
